<!DOCTYPE html>
<html lang="pt-br" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Meu Perfil - Alfa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <script src="data.js"></script>
    <script src="utils.js"></script>
    <script src="ui.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-white pb-10 transition-colors duration-300">

    <header class="bg-orange-600 dark:bg-gray-800 p-6 pb-12 rounded-b-[2.5rem] shadow-lg sticky top-0 z-40">
        <div class="flex justify-between items-center text-white mb-6">
            <a href="index.html" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 transition backdrop-blur-md">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-xl font-black uppercase tracking-wider">Meu Perfil</h1>
            <button onclick="alternarTema()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/30 transition backdrop-blur-md"><i id="icone-tema" class="fas fa-moon"></i></button>
        </div>
        
        <div class="text-center relative">
            <div class="relative w-28 h-28 mx-auto group">
                <input type="file" id="input-avatar" accept="image/*" class="hidden" onchange="uploadAvatar(this)">
                
                <label for="input-avatar" class="cursor-pointer block w-full h-full rounded-full overflow-hidden border-4 border-white/30 shadow-xl bg-orange-500 flex items-center justify-center relative">
                    <img id="img-avatar" src="" class="hidden w-full h-full object-cover">
                    <span id="txt-inicial" class="text-5xl font-black text-white/90">U</span>
                    
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                        <i class="fas fa-camera text-white text-2xl"></i>
                    </div>
                    <div id="loading-avatar" class="hidden absolute inset-0 bg-black/60 flex items-center justify-center">
                        <i class="fas fa-circle-notch fa-spin text-white text-2xl"></i>
                    </div>
                </label>
                
                <label for="input-avatar" class="absolute bottom-0 right-0 bg-white dark:bg-gray-700 text-orange-600 dark:text-orange-400 w-8 h-8 rounded-full flex items-center justify-center shadow-lg cursor-pointer hover:scale-110 transition border border-gray-100">
                    <i class="fas fa-pen text-xs"></i>
                </label>
            </div>
            
            <p id="perfil-nome" class="text-white font-black text-lg truncate mt-3">Carregando...</p>
            <p id="perfil-email" class="text-orange-100 text-xs font-medium opacity-80">...</p>
        </div>
    </header>

    <main class="max-w-md mx-auto p-6 -mt-6 space-y-6 relative z-10">
        
        <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl shadow-soft flex justify-between items-center gap-3">
            <a href="meus-pedidos.html" class="flex-1 bg-orange-50 dark:bg-gray-700/50 py-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-orange-100 dark:hover:bg-gray-600 transition group border border-transparent hover:border-orange-200">
                <div class="w-10 h-10 bg-orange-100 dark:bg-gray-600 rounded-full flex items-center justify-center text-orange-600 dark:text-orange-400 group-hover:scale-110 transition shadow-sm">
                    <i class="fas fa-receipt"></i>
                </div>
                <span class="text-[10px] font-black text-gray-600 dark:text-gray-300 uppercase tracking-wide">Pedidos</span>
            </a>
            <button onclick="logout()" class="flex-1 bg-red-50 dark:bg-red-900/10 py-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-red-100 dark:hover:bg-red-900/30 transition group border border-transparent hover:border-red-200">
                <div class="w-10 h-10 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center text-red-600 dark:text-red-400 group-hover:scale-110 transition shadow-sm">
                    <i class="fas fa-sign-out-alt"></i>
                </div>
                <span class="text-[10px] font-black text-red-600 dark:text-red-400 uppercase tracking-wide">Sair</span>
            </button>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-soft space-y-5 border border-gray-100 dark:border-gray-700">
            <h3 class="font-black text-orange-600 dark:text-orange-500 uppercase text-xs tracking-widest mb-2 border-b border-gray-100 dark:border-gray-700 pb-3 flex items-center gap-2">
                <i class="fas fa-user-edit"></i> Meus Dados
            </h3>
            
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Nome Completo</label>
                <input type="text" id="edit-nome" class="w-full p-4 bg-gray-50 dark:bg-gray-700 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-orange-500 transition text-gray-700 dark:text-white">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Celular / WhatsApp</label>
                <input type="text" id="edit-phone" class="phone_with_ddd w-full p-4 bg-gray-50 dark:bg-gray-700 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-orange-500 transition text-gray-700 dark:text-white">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2">Endereço Padrão</label>
                <textarea id="edit-address" rows="2" class="w-full p-4 bg-gray-50 dark:bg-gray-700 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-orange-500 transition resize-none text-gray-700 dark:text-white"></textarea>
            </div>

            <div class="space-y-1 pt-2 border-t border-dashed border-gray-200 dark:border-gray-700">
                <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 flex justify-between items-center">
                    E-mail de Acesso 
                    <span class="bg-orange-100 text-orange-600 text-[8px] px-2 py-0.5 rounded-full font-bold">Requer Confirmação</span>
                </label>
                <input type="email" id="edit-email" class="w-full p-4 bg-gray-50 dark:bg-gray-700 rounded-2xl outline-none font-bold text-sm border-2 border-transparent focus:border-orange-500 transition text-gray-700 dark:text-white">
            </div>

            <button onclick="salvarAlteracoes()" id="btn-salvar" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-green-200 dark:shadow-none hover:bg-green-700 active:scale-95 transition mt-2 flex items-center justify-center gap-2">
                <i class="fas fa-check"></i> SALVAR ALTERAÇÕES
            </button>
        </div>

        <div class="text-center pt-2">
            <button onclick="excluirConta()" class="text-[10px] font-bold text-red-400 hover:text-red-600 hover:underline transition uppercase tracking-wide">
                <i class="fas fa-trash mr-1"></i> Excluir minha conta permanentemente
            </button>
        </div>

        <footer class="mt-8 mb-4 text-center border-t border-gray-200 dark:border-gray-700 pt-6">
            <p class="text-[10px] text-gray-400 dark:text-gray-500 font-medium tracking-wide">Alfa Salgateria v1.0.0</p>
            <p class="text-[10px] text-gray-400 dark:text-gray-500 mt-1">
                Desenvolvido por <span class="font-bold text-orange-500">TG Tech</span>
            </p>
        </footer>

    </main>

    <script>
        $(document).ready(function(){ $('.phone_with_ddd').mask('(00) 00000-0000'); });

        let originalEmail = "";

        async function initPerfil() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'cliente-login.html'; return; }

            const { data: cliente } = await _supabase.from('clients').select('*').eq('id', session.user.id).single();
            
            if (cliente) {
                document.getElementById('perfil-nome').innerText = cliente.name;
                document.getElementById('perfil-email').innerText = session.user.email;
                
                // Lógica de Foto de Perfil
                if (cliente.avatar_url) {
                    document.getElementById('img-avatar').src = cliente.avatar_url;
                    document.getElementById('img-avatar').classList.remove('hidden');
                    document.getElementById('txt-inicial').classList.add('hidden');
                } else {
                    document.getElementById('txt-inicial').innerText = cliente.name.charAt(0).toUpperCase();
                }
                
                document.getElementById('edit-nome').value = cliente.name;
                document.getElementById('edit-phone').value = cliente.phone;
                document.getElementById('edit-address').value = cliente.address;
                document.getElementById('edit-email').value = session.user.email;
                originalEmail = session.user.email;
            }
        }

        // --- UPLOAD DE FOTO ---
        async function uploadAvatar(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const loading = document.getElementById('loading-avatar');
                loading.classList.remove('hidden'); 

                try {
                    const { data: { session } } = await _supabase.auth.getSession();
                    const userId = session.user.id;
                    const fileName = `avatar_${userId}_${Date.now()}`;

                    const { error: uploadError } = await _supabase.storage.from('assets').upload(fileName, file);
                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = _supabase.storage.from('assets').getPublicUrl(fileName);

                    const { error: dbError } = await _supabase.from('clients').update({ avatar_url: publicUrl }).eq('id', userId);
                    if (dbError) throw dbError;

                    document.getElementById('img-avatar').src = publicUrl;
                    document.getElementById('img-avatar').classList.remove('hidden');
                    document.getElementById('txt-inicial').classList.add('hidden');
                    mostrarToast("Foto atualizada!");

                } catch (error) {
                    console.error(error);
                    mostrarToast("Erro ao enviar foto", "erro");
                } finally {
                    loading.classList.add('hidden'); 
                }
            }
        }

        async function salvarAlteracoes() {
            const btn = document.getElementById('btn-salvar');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> SALVANDO...';

            const nome = document.getElementById('edit-nome').value;
            const phone = document.getElementById('edit-phone').value;
            const address = document.getElementById('edit-address').value;
            const email = document.getElementById('edit-email').value;

            if(!nome || !phone) {
                mostrarToast("Nome e Celular são obrigatórios!", "erro");
                btn.disabled = false; btn.innerText = "SALVAR ALTERAÇÕES";
                return;
            }

            try {
                const { data: { session } } = await _supabase.auth.getSession();

                const { error: errData } = await _supabase.from('clients').update({
                    name: nome, phone: phone, address: address
                }).eq('id', session.user.id);

                if (errData) throw errData;

                if (email !== originalEmail) {
                    if(confirm("Ao mudar o e-mail, você será deslogado para confirmar o novo endereço. Continuar?")) {
                        const { error: errAuth } = await _supabase.auth.updateUser({ email: email });
                        if (errAuth) throw errAuth;
                        mostrarToast("Verifique seu novo e-mail!");
                    }
                } else {
                    mostrarToast("Perfil atualizado!");
                    setTimeout(() => location.reload(), 1000);
                }

            } catch (error) {
                mostrarToast("Erro ao atualizar", "erro");
            } finally {
                btn.disabled = false; btn.innerHTML = '<i class="fas fa-check"></i> SALVAR ALTERAÇÕES';
            }
        }

        async function excluirConta() {
            const confirmacao = prompt("Para EXCLUIR SUA CONTA permanentemente, digite DELETAR:");
            if (confirmacao === "DELETAR") {
                mostrarToast("Excluindo...", "erro");
                const { error } = await _supabase.rpc('delete_user');
                if (error) {
                    console.error(error);
                    await _supabase.from('clients').delete().eq('id', (await _supabase.auth.getUser()).data.user.id);
                    await _supabase.auth.signOut();
                }
                alert("Conta excluída. Até logo!");
                window.location.href = 'index.html';
            }
        }

        async function logout() {
            await _supabase.auth.signOut();
            window.location.href = 'cliente-login.html';
        }

        initPerfil();
    </script>
</body>
</html>