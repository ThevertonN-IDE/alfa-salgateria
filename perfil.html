<!DOCTYPE html>
<html lang="pt-br" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ea580c">
    <title>Meu Perfil | Alfa Salgateria</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="data.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { alfa: { 500: '#ea580c', 600: '#c2410c' } }
                }
            }
        }
    </script>

    <style>
        /* --- ESTILOS PADRÃO --- */
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* HEADER */
        .header-bg {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.25);
        }

        .dark .header-bg {
            background: #1f2937;
            border-bottom: 1px solid #374151;
            box-shadow: none;
        }

        /* FUNDO */
        .bg-body {
            background-color: #f8fafc;
            color: #1e293b;
        }

        .dark .bg-body {
            background-color: #111827;
            color: #f3f4f6;
        }

        .bg-pattern {
            background-image: radial-gradient(#ea580c 0.5px, transparent 0.5px);
            background-size: 24px 24px;
            opacity: 0.8;
        }

        .dark .bg-pattern {
            background-image: none;
        }

        /* INPUTS E SELECTS */
        .input-perfil {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            color: #334155;
            transition: all 0.2s;
            appearance: none;
        }

        .input-perfil:focus {
            border-color: #ea580c;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }

        .dark .input-perfil {
            background-color: #1f2937;
            border-color: #374151;
            color: #ffffff;
        }

        /* CARDS */
        .card-bg {
            background-color: #ffffff;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .dark .card-bg {
            background-color: #1f2937;
            border-color: #374151;
            box-shadow: none;
        }
    </style>
</head>

<body class="bg-body bg-pattern transition-colors duration-300 flex flex-col min-h-screen">

    <header
        class="header-bg text-white h-16 shadow-lg sticky top-0 z-50 flex items-center justify-between px-4 transition-colors">
        <button onclick="window.location.href='index.html'"
            class="w-10 h-10 rounded-full bg-white text-orange-600 flex items-center justify-center shadow-md active:scale-95 transition">
            <i class="fas fa-arrow-left font-bold"></i>
        </button>

        <span class="font-black text-lg tracking-wide uppercase text-shadow">Meu Perfil</span>

        <div class="w-10"></div>
    </header>

    <main class="flex-grow p-6 w-full max-w-md mx-auto space-y-6">

        <div class="flex flex-col items-center justify-center -mt-2">
            <div class="relative group">
                <div id="avatar-container"
                    class="w-28 h-28 rounded-full bg-white dark:bg-gray-800 p-1 shadow-xl border-2 border-orange-500 overflow-hidden flex items-center justify-center relative">
                    <i class="fas fa-spinner fa-spin text-orange-500 text-2xl"></i>
                </div>
                <label
                    class="absolute bottom-0 right-0 bg-orange-600 text-white w-9 h-9 rounded-full flex items-center justify-center shadow-lg cursor-pointer active:scale-95 transition hover:bg-orange-700 border-2 border-white dark:border-gray-900">
                    <i class="fas fa-camera text-xs"></i>
                    <input type="file" id="input-avatar" accept="image/*" class="hidden" onchange="uploadAvatar()">
                </label>
            </div>
            <p id="user-phone-display" class="mt-3 text-sm font-bold opacity-60"></p>
        </div>

        <div class="space-y-4">

            <div class="card-bg p-5 rounded-3xl space-y-4">
                <h3 class="text-xs font-black text-orange-500 uppercase tracking-widest mb-2">Dados Pessoais</h3>

                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 opacity-70">Nome Completo</label>
                    <input type="text" id="nome" class="w-full px-4 py-3 rounded-xl input-perfil font-bold outline-none"
                        placeholder="Seu nome">
                </div>

                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 opacity-70">E-mail</label>
                    <input type="email" id="email"
                        class="w-full px-4 py-3 rounded-xl input-perfil font-bold outline-none"
                        placeholder="seu@email.com">
                    <p class="text-[10px] text-gray-400 mt-1 ml-1"><i class="fas fa-info-circle"></i> A alteração requer
                        confirmação no novo e-mail.</p>
                </div>

                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 opacity-70">Telefone (Whatsapp)</label>
                    <input type="tel" id="telefone"
                        class="w-full px-4 py-3 rounded-xl input-perfil font-bold outline-none opacity-60 cursor-not-allowed"
                        readonly>
                </div>
            </div>

            <div class="card-bg p-5 rounded-3xl space-y-4">
                <h3 class="text-xs font-black text-orange-500 uppercase tracking-widest mb-2">Endereço de Entrega</h3>

                <div class="grid grid-cols-[2fr_1fr] gap-3">
                    <div>
                        <label class="block text-xs font-bold mb-1 ml-1 opacity-70">Logradouro</label>
                        <input type="text" id="rua"
                            class="w-full px-4 py-3 rounded-xl input-perfil font-bold outline-none"
                            placeholder="Rua/Av">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1 ml-1 opacity-70">Nº</label>
                        <input type="text" id="numero"
                            class="w-full px-4 py-3 rounded-xl input-perfil font-bold outline-none" placeholder="123">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 opacity-70">Bairro</label>
                    <div class="relative">
                        <select id="bairro"
                            class="w-full px-4 py-3 rounded-xl input-perfil font-bold outline-none cursor-pointer">
                            <option value="" disabled selected>Carregando bairros...</option>
                        </select>
                        <div
                            class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-gray-400">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold mb-1 ml-1 opacity-70">Ponto de Referência</label>
                    <input type="text" id="referencia"
                        class="w-full px-4 py-3 rounded-xl input-perfil font-bold outline-none"
                        placeholder="Ex: Próximo à praça...">
                </div>
            </div>

            <button onclick="salvarPerfil()"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-2xl font-black shadow-lg shadow-green-200/50 active:scale-95 transition uppercase tracking-wide flex items-center justify-center gap-2">
                <i class="fas fa-save"></i> Salvar Alterações
            </button>

            <button onclick="fazerLogout()"
                class="w-full bg-red-50 dark:bg-red-900/20 text-red-500 border border-red-100 dark:border-red-900 py-3.5 rounded-2xl font-bold active:scale-95 transition hover:bg-red-100 dark:hover:bg-red-900/40 flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Sair da Conta
            </button>

        </div>

        <p class="text-center text-[10px] opacity-40 font-mono py-4">ID: <span id="user-uid">...</span></p>
    </main>

    <script>
        let user = null;
        let authEmail = ''; // Armazena o email atual para comparação

        function aplicarTema() {
            const html = document.documentElement;
            const isDark = localStorage.getItem('tema') === 'dark';

            if (isDark) html.classList.add('dark');
            else html.classList.remove('dark');

            // Atualiza a barra de status do celular
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            if (!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = "theme-color";
                document.head.appendChild(metaTheme);
            }

            // Puxa a cor exata do CSS (Motor Camaleão) ou fica cinza escuro no Dark Mode
            const corPrimaria = getComputedStyle(html).getPropertyValue('--cor-primaria').trim() || '#ea580c';
            metaTheme.setAttribute('content', isDark ? '#111827' : corPrimaria);
        }
        aplicarTema();

        // CARREGAR BAIRROS
        async function carregarBairros() {
            const select = document.getElementById('bairro');
            try {
                // Busca da tabela delivery_fees coluna 'neighborhood'
                const { data, error } = await _supabase.from('delivery_fees').select('*').order('neighborhood');

                select.innerHTML = '<option value="" disabled selected>Selecione seu bairro</option>';

                if (error) throw error;

                if (data && data.length > 0) {
                    data.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b.neighborhood;
                        opt.innerText = b.neighborhood;
                        select.appendChild(opt);
                    });
                } else {
                    select.innerHTML = '<option value="">Nenhum bairro encontrado</option>';
                }
            } catch (e) {
                console.warn('Erro ao carregar bairros:', e);
                select.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        async function initPerfil() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) return window.location.href = 'cliente-login.html';

            // Armazena e exibe o e-mail atual
            authEmail = session.user.email;
            document.getElementById('email').value = authEmail;

            await carregarBairros();

            const { data: u, error } = await _supabase.from('clients').select('*').eq('id', session.user.id).single();
            if (error || !u) return;

            user = u;
            renderizarDados();
        }

        function renderizarDados() {
            document.getElementById('nome').value = user.name || '';
            document.getElementById('telefone').value = user.phone || '';
            document.getElementById('user-phone-display').innerText = user.phone || '';
            document.getElementById('user-uid').innerText = user.id.slice(0, 8);

            const container = document.getElementById('avatar-container');
            if (user.avatar_url) {
                container.innerHTML = `<img src="${user.avatar_url}" class="w-full h-full object-cover">`;
            } else {
                const inicial = user.name ? user.name.charAt(0).toUpperCase() : '?';
                container.innerHTML = `<span class="text-4xl font-black text-orange-500">${inicial}</span>`;
            }

            // Separar endereço
            if (user.address) {
                const partes = user.address.split(',');
                if (partes.length > 1) {
                    document.getElementById('rua').value = partes[0].trim();
                    const resto = partes.slice(1).join(',');

                    const partes2 = resto.split('-');
                    if (partes2.length > 0) {
                        document.getElementById('numero').value = partes2[0].trim();

                        if (partes2[1]) {
                            const bairroSalvo = partes2[1].trim();
                            const selectBairro = document.getElementById('bairro');
                            let achou = false;
                            for (let i = 0; i < selectBairro.options.length; i++) {
                                if (selectBairro.options[i].value === bairroSalvo) {
                                    selectBairro.selectedIndex = i;
                                    achou = true;
                                    break;
                                }
                            }
                            if (!achou) {
                                const opt = document.createElement('option');
                                opt.value = bairroSalvo;
                                opt.innerText = bairroSalvo + " (Antigo)";
                                opt.selected = true;
                                selectBairro.appendChild(opt);
                            }
                        }

                        if (partes2[2]) document.getElementById('referencia').value = partes2[2].replace(/\(|\)/g, '').trim();
                    } else {
                        document.getElementById('numero').value = resto.trim();
                    }
                } else {
                    document.getElementById('rua').value = user.address;
                }
            }
        }

        async function uploadAvatar() {
            const file = document.getElementById('input-avatar').files[0];
            if (!file) return;
            document.getElementById('avatar-container').innerHTML = `<i class="fas fa-spinner fa-spin text-orange-500 text-3xl"></i>`;
            try {
                const ext = file.name.split('.').pop();
                const fileName = `avatar_${user.id}_${Date.now()}.${ext}`;
                const { error: uploadError } = await _supabase.storage.from('imagens').upload(`avatars/${fileName}`, file);
                if (uploadError) throw uploadError;
                const { data } = _supabase.storage.from('imagens').getPublicUrl(`avatars/${fileName}`);
                await _supabase.from('clients').update({ avatar_url: data.publicUrl }).eq('id', user.id);
                user.avatar_url = data.publicUrl;
                renderizarDados();
                Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Foto atualizada!', showConfirmButton: false, timer: 1500 });
            } catch (error) {
                console.error(error);
                renderizarDados();
            }
        }

        async function salvarPerfil() {
            const nome = document.getElementById('nome').value.trim();
            const novoEmail = document.getElementById('email').value.trim();
            const rua = document.getElementById('rua').value.trim();
            const num = document.getElementById('numero').value.trim();
            const bairro = document.getElementById('bairro').value;
            const ref = document.getElementById('referencia').value.trim();

            if (!nome) return Swal.fire('Atenção', 'O nome é obrigatório.', 'warning');
            if (!bairro) return Swal.fire('Atenção', 'Selecione um bairro.', 'warning');
            if (!novoEmail) return Swal.fire('Atenção', 'O e-mail é obrigatório.', 'warning');

            // 1. Verificar alteração de e-mail
            let msgEmail = '';
            if (novoEmail !== authEmail) {
                const { data, error } = await _supabase.auth.updateUser({ email: novoEmail });
                if (error) {
                    return Swal.fire('Erro no E-mail', error.message, 'error');
                }
                msgEmail = '<br><br><b>Atenção:</b> Enviamos um link de confirmação para o seu novo e-mail. A alteração só será concluída após o clique.';
            }

            // 2. Salvar dados do perfil
            let enderecoCompleto = "";
            if (rua) {
                enderecoCompleto = `${rua}, ${num} - ${bairro}`;
                if (ref) enderecoCompleto += ` (${ref})`;
            }

            try {
                const { error } = await _supabase.from('clients').update({ name: nome, address: enderecoCompleto }).eq('id', user.id);
                if (error) throw error;

                Swal.fire({
                    icon: 'success',
                    title: 'Perfil Salvo!',
                    html: 'Seus dados foram atualizados com sucesso.' + msgEmail,
                    confirmButtonColor: '#ea580c'
                });

                // Atualiza o email de referência se não houve erro
                if (novoEmail !== authEmail) authEmail = novoEmail;

            } catch (error) {
                console.error(error);
                Swal.fire('Erro', 'Não foi possível salvar os dados.', 'error');
            }
        }

        async function fazerLogout() {
            await _supabase.auth.signOut();
            localStorage.removeItem('carrinho_alfa_v10');
            window.location.href = 'index.html';
        }

        initPerfil();
    </script>
</body>

</html>