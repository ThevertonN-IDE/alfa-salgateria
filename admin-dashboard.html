<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatﾃｳrios - Alfa Salgateria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="data.js"></script>
    <script src="utils.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f8fafc;
        }

        /* Estilos do Menu de Abas e Calendﾃ｡rio */
        .tab-nav {
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 2rem;
            padding-top: 1rem;
            overflow-x: auto;
        }

        .tab-link {
            padding-bottom: 0.75rem;
            font-weight: 700;
            color: #64748b;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-link.active {
            color: #9333ea;
            border-color: #9333ea;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        .date-input {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: #334155;
            outline: none;
            text-transform: uppercase;
            cursor: pointer;
        }

        .date-input:focus {
            border-color: #9333ea;
            box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- MODO DE IMPRESSﾃグ --- */
        @media print {
            body * {
                visibility: hidden;
                height: 0;
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            #print-area,
            #print-area * {
                visibility: visible;
                height: auto;
                overflow: visible;
            }

            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                background: white;
                color: black;
                font-family: 'Courier New', monospace;
                z-index: 99999;
                display: block !important;
            }
        }
    </style>
</head>

<body class="pb-20">

    <header class="bg-white shadow-sm sticky top-0 z-30 px-6 pt-5 flex flex-col gap-4">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
            <h1 class="font-black text-2xl text-gray-800 flex items-center gap-3 tracking-tight">
                <div
                    class="w-10 h-10 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center shadow-inner">
                    <i class="fas fa-chart-pie"></i>
                </div>
                Centro de Inteligﾃｪncia
            </h1>
            <a href="admin-kanban.html"
                class="bg-gray-50 border border-gray-200 text-gray-600 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-100 transition shadow-sm flex items-center gap-2 w-max"><i
                    class="fas fa-arrow-left"></i> Voltar ao Kanban</a>
        </div>

        <nav class="tab-nav custom-scroll hide-scrollbar">
            <button onclick="mudarAba('geral')" id="tab-btn-geral" class="tab-link active"><i
                    class="fas fa-columns mr-1"></i> Visﾃ｣o Geral</button>
            <button onclick="mudarAba('produtos')" id="tab-btn-produtos" class="tab-link"><i
                    class="fas fa-medal mr-1"></i> Mais Vendidos</button>
            <button onclick="mudarAba('clientes')" id="tab-btn-clientes" class="tab-link"><i
                    class="fas fa-users mr-1"></i> Histﾃｳrico de Clientes</button>
        </nav>
    </header>

    <main class="max-w-[1400px] mx-auto px-6 py-8">

        <div
            class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 mb-8 flex flex-col xl:flex-row justify-between items-start xl:items-center gap-5">
            <div class="flex gap-2 flex-wrap">
                <button onclick="filtrarPeriodoRapido('hoje', this)"
                    class="filter-btn active bg-purple-600 text-white px-5 py-2 rounded-xl text-xs font-black uppercase tracking-wider transition shadow-md">Hoje</button>
                <button onclick="filtrarPeriodoRapido('ontem', this)"
                    class="filter-btn bg-gray-50 text-gray-500 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-gray-100 transition border border-gray-200">Ontem</button>
                <button onclick="filtrarPeriodoRapido('semana', this)"
                    class="filter-btn bg-gray-50 text-gray-500 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-gray-100 transition border border-gray-200">7
                    Dias</button>
                <button onclick="filtrarPeriodoRapido('mes', this)"
                    class="filter-btn bg-gray-50 text-gray-500 px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-gray-100 transition border border-gray-200">Este
                    Mﾃｪs</button>
            </div>

            <div
                class="flex items-center gap-3 bg-gray-50/50 p-2 rounded-xl border border-gray-200 w-full xl:w-auto overflow-x-auto custom-scroll">
                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest pl-2">Personalizado:</span>
                <input type="date" id="data-inicio" class="date-input bg-white" onchange="limparFiltrosRapidos()">
                <span class="text-gray-400 font-bold text-xs">Atﾃｩ</span>
                <input type="date" id="data-fim" class="date-input bg-white" onchange="limparFiltrosRapidos()">
                <button onclick="buscarPorDataCustomizada()"
                    class="bg-blue-600 text-white w-9 h-9 rounded-lg flex items-center justify-center hover:bg-blue-700 transition shadow-sm flex-shrink-0"
                    title="Buscar"><i class="fas fa-search"></i></button>
            </div>
        </div>

        <div id="mensagem-vazio"
            class="hidden text-center py-16 bg-white rounded-3xl border border-gray-100 shadow-sm mb-8">
            <i class="fas fa-folder-open text-6xl text-gray-200 mb-4 block"></i>
            <h3 class="text-xl font-black text-gray-500">Nenhum pedido registrado</h3>
            <p class="text-sm text-gray-400 mt-2">Tente selecionar outra data no calendﾃ｡rio.</p>
        </div>

        <div id="aba-geral" class="tab-content active space-y-8">

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-5" id="grid-kpis">

                <div
                    class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden group hover:border-purple-200 transition">
                    <div
                        class="absolute -right-4 -top-4 text-green-500 opacity-5 text-7xl transform group-hover:scale-110 transition duration-500">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 relative z-10">Receita
                        Bruta</p>
                    <h3 class="text-2xl lg:text-3xl font-black text-gray-800 tracking-tight relative z-10"
                        id="kpi-total">R$ 0,00</h3>
                    <p class="text-[10px] font-bold mt-2 relative z-10" id="kpi-growth"><span
                            class="text-gray-400">Calculando...</span></p>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-blue-100 bg-blue-50/40 relative">
                    <p
                        class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-box-open"></i> Produtos
                    </p>
                    <h3 class="text-2xl font-black text-gray-800" id="kpi-produtos">R$ 0,00</h3>
                    <p class="text-[10px] font-bold text-gray-500 mt-2">Valor livre de taxas de frete</p>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 bg-gray-50/80 relative">
                    <p
                        class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-motorcycle"></i> Taxas Entrega
                    </p>
                    <h3 class="text-2xl font-black text-gray-800" id="kpi-frete">R$ 0,00</h3>
                    <p class="text-[10px] font-bold text-gray-400 mt-2">Repasse para entregadores</p>
                </div>

                <div id="card-kpi-encomendas"
                    class="bg-white p-5 rounded-3xl shadow-sm border border-orange-100 bg-orange-50/40 relative hidden">
                    <p
                        class="text-[10px] font-black text-orange-600 uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i class="fas fa-calendar-check"></i> Sinal Encomendas
                    </p>
                    <h3 class="text-2xl font-black text-gray-800" id="kpi-sinal">R$ 0,00</h3>
                    <p class="text-[10px] font-bold text-gray-500 mt-2">50% jﾃ｡ garantidos via Pix</p>
                </div>

                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 relative">
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Volume de Vendas</p>
                    <h3 class="text-2xl font-black text-gray-800 flex items-baseline gap-1"><span
                            id="kpi-count">0</span> <span
                            class="text-[10px] text-gray-400 uppercase tracking-wider">Pedidos</span></h3>
                    <p class="text-[10px] font-bold text-gray-500 mt-2 border-t border-gray-100 pt-2">Ticket Mﾃｩdio:
                        <span id="kpi-ticket" class="text-gray-800 font-black">R$ 0,00</span>
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-1">Vendas Totais</p>
                    <h3 class="text-3xl font-black text-gray-800" id="kpi-total">R$ 0,00</h3>
                    <p class="text-xs font-bold mt-2 flex items-center gap-1" id="kpi-growth">
                        <span class="bg-gray-100 text-gray-400 px-1.5 py-0.5 rounded">--</span> vs. perﾃｭodo anterior
                    </p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-1">Produtos vs. Entregas</p>
                    <div class="flex items-end gap-2">
                        <div>
                            <span class="text-xs text-blue-500 font-bold block">Produtos</span>
                            <span class="text-lg font-black text-gray-800" id="kpi-produtos">R$ 0,00</span>
                        </div>
                        <div class="h-8 w-px bg-gray-200"></div>
                        <div>
                            <span class="text-xs text-orange-500 font-bold block">Entregas</span>
                            <span class="text-lg font-black text-gray-800" id="kpi-frete">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-1">Pedidos Realizados</p>
                    <h3 class="text-3xl font-black text-gray-800" id="kpi-count">0</h3>
                    <p class="text-xs text-gray-400 mt-2 font-medium">Ticket Mﾃｩdio: <span
                            class="font-bold text-gray-600" id="kpi-ticket">R$ 0,00</span></p>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-1">Forma Pagamento</p>
                    <div class="h-24"><canvas id="chart-pagamento"></canvas></div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Evoluﾃｧﾃ｣o de Vendas</h4>
                    <div class="h-64"><canvas id="chart-evolucao"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-700 mb-4 text-sm uppercase">Horﾃ｡rios de Pico (Pedidos)</h4>
                    <div class="h-64"><canvas id="chart-horarios"></canvas></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h4 class="font-bold text-gray-800 uppercase text-sm">Detalhamento dos Pedidos</h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-50 text-xs uppercase font-bold text-gray-400">
                            <tr>
                                <th class="px-6 py-4">Data</th>
                                <th class="px-6 py-4">Cliente</th>
                                <th class="px-6 py-4">Tipo</th>
                                <th class="px-6 py-4 text-right">Valor</th>
                                <th class="px-6 py-4 text-center">Aﾃｧﾃ｣o</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100" id="tabela-pedidos"></tbody>
                    </table>
                </div>
            </div>

    </main>

    <div id="modal-view" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-xl">Detalhes do Pedido</h3>
                <button onclick="document.getElementById('modal-view').classList.add('hidden')"
                    class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-content" class="space-y-3 text-sm"></div>
        </div>
    </div>
    </div>
    <div id="aba-produtos" class="tab-content space-y-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-black text-gray-800">Ranking de Produtos</h2>
            <span class="text-xs font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full"><i
                    class="fas fa-filter"></i> Reflete o perﾃｭodo selecionado</span>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm text-gray-600">
                    <thead class="bg-gray-50 text-[10px] uppercase font-bold text-gray-400 border-b border-gray-100">
                        <tr>
                            <th class="px-6 py-4 w-16 text-center">Posiﾃｧﾃ｣o</th>
                            <th class="px-6 py-4">Produto</th>
                            <th class="px-6 py-4 text-center">Qtd Vendida</th>
                            <th class="px-6 py-4 text-right">Receita Gerada</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50" id="tabela-ranking-produtos">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="aba-clientes" class="tab-content space-y-6">
        <h2 class="text-xl font-black text-gray-800 mb-4">Fidelidade e Recorrﾃｪncia</h2>
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center text-gray-500">
            <i class="fas fa-tools text-3xl mb-3"></i><br>Carregando histﾃｳrico...
        </div>
    </div>

    </main>
    <div id="print-area" style="display:none;"></div>
    <script>
        let charts = {};
        const ctxEvolucao = document.getElementById('chart-evolucao').getContext('2d');
        const ctxHorarios = document.getElementById('chart-horarios').getContext('2d');
        const ctxPagamento = document.getElementById('chart-pagamento').getContext('2d');

        // Formataﾃｧﾃ｣o de Moeda
        const fmtMoney = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

        // --- SISTEMA DE ABAS ---
        function mudarAba(abaId) {
            // Esconde todos os conteﾃｺdos
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Remove a cor ativa de todos os botﾃｵes
            document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));

            // Ativa apenas a clicada
            document.getElementById(`aba-${abaId}`).classList.add('active');
            document.getElementById(`tab-btn-${abaId}`).classList.add('active');
        }

        // --- CONTROLE DE FILTROS ---
        let periodoAtual = 'hoje';

        function limparFiltrosRapidos() {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-purple-600', 'text-white', 'active');
                b.classList.add('bg-gray-50', 'text-gray-500');
            });
            periodoAtual = 'custom';
        }

        function filtrarPeriodoRapido(p, btn) {
            limparFiltrosRapidos();
            btn.classList.remove('bg-gray-50', 'text-gray-500');
            btn.classList.add('bg-purple-600', 'text-white', 'active');

            // Limpa os inputs de data para nﾃ｣o confundir o usuﾃ｡rio
            document.getElementById('data-inicio').value = '';
            document.getElementById('data-fim').value = '';

            periodoAtual = p;
            carregarRelatorios();
        }

        function buscarPorDataCustomizada() {
            const dtIni = document.getElementById('data-inicio').value;
            const dtFim = document.getElementById('data-fim').value;

            if (!dtIni || !dtFim) {
                Swal.fire('Atenﾃｧﾃ｣o', 'Selecione a data de inﾃｭcio e fim no calendﾃ｡rio.', 'warning');
                return;
            }
            limparFiltrosRapidos();
            carregarRelatorios('custom', dtIni, dtFim);
        }

        // --- MOTOR DE BUSCA (SUPABASE) ---
        async function carregarRelatorios(periodoOverride = null, customStart = null, customEnd = null) {
            const periodo = periodoOverride || periodoAtual;

            const hoje = new Date();
            let inicio = new Date();
            let fim = new Date();
            let inicioComp = new Date(); // Para comparar com o mﾃｪs/semana passado
            let fimComp = new Date();

            if (periodo === 'hoje') {
                inicio.setHours(0, 0, 0, 0);
                inicioComp.setDate(inicio.getDate() - 1);
                fimComp.setDate(inicio.getDate() - 1); fimComp.setHours(23, 59, 59, 999);
            } else if (periodo === 'ontem') {
                inicio.setDate(hoje.getDate() - 1); inicio.setHours(0, 0, 0, 0);
                fim.setDate(hoje.getDate() - 1); fim.setHours(23, 59, 59, 999);
                inicioComp.setDate(inicio.getDate() - 1);
                fimComp.setDate(fim.getDate() - 1);
            } else if (periodo === 'semana') {
                inicio.setDate(hoje.getDate() - 7); inicio.setHours(0, 0, 0, 0);
                inicioComp.setDate(inicio.getDate() - 7);
                fimComp.setDate(fim.getDate() - 7);
            } else if (periodo === 'mes') {
                inicio.setDate(1); inicio.setHours(0, 0, 0, 0);
                inicioComp.setMonth(inicio.getMonth() - 1); inicioComp.setDate(1);
                fimComp.setDate(0); fimComp.setHours(23, 59, 59, 999);
            } else if (periodo === 'custom') {
                // Adiciona o timezone para nﾃ｣o dar erro de dia anterior
                inicio = new Date(`${customStart}T00:00:00`);
                fim = new Date(`${customEnd}T23:59:59`);

                // Calcula a diferenﾃｧa em dias para buscar um perﾃｭodo anterior igual
                const diffTime = Math.abs(fim - inicio);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                inicioComp = new Date(inicio); inicioComp.setDate(inicio.getDate() - diffDays);
                fimComp = new Date(fim); fimComp.setDate(fim.getDate() - diffDays);
            }

            try {
                // 1. Busca configuraﾃｧﾃｵes da loja (Para saber se esconde as Encomendas)
                const { data: config } = await _supabase.from('store_config').select('schedule_config').limit(1).single();
                const usaEncomenda = config?.schedule_config?.ativo !== false;

                if (usaEncomenda) {
                    document.getElementById('card-kpi-encomendas').classList.remove('hidden');
                } else {
                    document.getElementById('card-kpi-encomendas').classList.add('hidden');
                }

                // 2. Busca Pedidos Atuais
                const { data: pedidos, error } = await _supabase.from('orders')
                    .select('*')
                    .neq('status', 'cancelado') // Nﾃ｣o conta dinheiro de pedido cancelado
                    .gte('created_at', inicio.toISOString())
                    .lte('created_at', fim.toISOString())
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // 3. Busca Pedidos Antigos (Sﾃｳ para comparaﾃｧﾃ｣o de Crescimento)
                const { data: pedidosComp } = await _supabase.from('orders')
                    .select('total_amount')
                    .neq('status', 'cancelado')
                    .gte('created_at', inicioComp.toISOString())
                    .lte('created_at', fimComp.toISOString());

                processarDados(pedidos || [], pedidosComp || []);

            } catch (err) {
                console.error("Erro ao buscar dados:", err);
                Swal.fire('Erro', 'Falha ao buscar relatﾃｳrios.', 'error');
            }
        }

        // --- PROCESSAMENTO E MATEMﾃゝICA ---
        function processarDados(pedidos, comparacao) {
            const vazioMsg = document.getElementById('mensagem-vazio');
            const abaGeral = document.getElementById('aba-geral');

            if (!pedidos || pedidos.length === 0) {
                vazioMsg.classList.remove('hidden');
                abaGeral.classList.add('hidden');
                return;
            } else {
                vazioMsg.classList.add('hidden');
                // Sﾃｳ mostra o painel geral se a aba geral for a atual
                if (document.getElementById('tab-btn-geral').classList.contains('active')) {
                    abaGeral.classList.remove('hidden');
                }
            }

            // 1. Cﾃ｡lculos Base
            let totalBruto = 0;
            let totalFrete = 0;
            let totalSinalEncomenda = 0;

            pedidos.forEach(p => {
                totalBruto += Number(p.total_amount);

                // Soma taxa de entrega (se houver a coluna, ou estima se for 'entrega')
                totalFrete += Number(p.delivery_fee || (p.delivery_type === 'entrega' ? 5 : 0));

                // Se o pedido tiver a etiqueta de encomenda no endereﾃｧo, metade do valor ﾃｩ Sinal
                if (p.address && p.address.includes('[套 ENCOMENDA:')) {
                    totalSinalEncomenda += (Number(p.total_amount) / 2);
                }
            });

            const totalProdutos = totalBruto - totalFrete;
            const totalComp = comparacao.reduce((acc, p) => acc + Number(p.total_amount), 0);
            const count = pedidos.length;

            // Renderiza KPIs
            document.getElementById('kpi-total').innerText = fmtMoney(totalBruto);
            document.getElementById('kpi-produtos').innerText = fmtMoney(totalProdutos);
            document.getElementById('kpi-frete').innerText = fmtMoney(totalFrete);
            document.getElementById('kpi-sinal').innerText = fmtMoney(totalSinalEncomenda);
            document.getElementById('kpi-count').innerText = count;
            document.getElementById('kpi-ticket').innerText = count ? fmtMoney(totalBruto / count) : 'R$ 0,00';

            // Crescimento (Seta Verde ou Vermelha)
            const growthEl = document.getElementById('kpi-growth');
            if (totalComp > 0) {
                const perc = ((totalBruto - totalComp) / totalComp) * 100;
                const cor = perc >= 0 ? 'text-green-500' : 'text-red-500';
                const icone = perc >= 0 ? '<i class="fas fa-arrow-trend-up"></i>' : '<i class="fas fa-arrow-trend-down"></i>';
                growthEl.innerHTML = `<span class="${cor} font-black bg-${cor.replace('text-', '')}/10 px-2 py-0.5 rounded mr-1">${icone} ${Math.abs(perc).toFixed(1)}%</span> vs. ant.`;
            } else {
                growthEl.innerHTML = `<span class="text-gray-400 font-medium">Sem dados anteriores para comparar</span>`;
            }

            // 2. Grﾃ｡fico Horﾃ｡rios
            const horarios = Array(24).fill(0);
            pedidos.forEach(p => {
                const h = new Date(p.created_at).getHours();
                horarios[h]++;
            });
            renderChart('chart-horarios', ctxHorarios, 'bar', horarios, 'Pedidos por Hora', ['#a855f7']);

            // 3. Grﾃ｡fico Pagamento (Limpeza de nomes)
            const pagamentos = { pix: 0, dinheiro: 0, cartao: 0 };
            pedidos.forEach(p => {
                let metodo = (p.payment_method || '').toLowerCase();
                if (metodo.includes('pix')) pagamentos.pix++;
                else if (metodo.includes('dinheiro')) pagamentos.dinheiro++;
                else if (metodo.includes('cartao') || metodo.includes('cartﾃ｣o')) pagamentos.cartao++;
                else pagamentos.pix++; // Fallback se nﾃ｣o identificar
            });
            renderChart('chart-pagamento', ctxPagamento, 'doughnut', Object.values(pagamentos), 'Pagamentos', ['#22c55e', '#3b82f6', '#f59e0b'], ['Pix', 'Dinheiro', 'Cartﾃ｣o']);

            // 4. Grﾃ｡fico de Evoluﾃｧﾃ｣o de Vendas (Diﾃ｡rio)
            const diasVenda = {};
            pedidos.forEach(p => {
                const dia = new Date(p.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                if (!diasVenda[dia]) diasVenda[dia] = 0;
                diasVenda[dia] += Number(p.total_amount);
            });

            // Inverte para ficar na ordem cronolﾃｳgica (mais antigo na esquerda)
            const labelsEvolucao = Object.keys(diasVenda).reverse();
            const dadosEvolucao = Object.values(diasVenda).reverse();

            renderChart('chart-evolucao', ctxEvolucao, 'line', dadosEvolucao, 'R$ Faturado', ['#ea580c'], labelsEvolucao);

            // 5. Tabela Detalhada (Com tag visual para encomendas)
            const tbody = document.getElementById('tabela-pedidos');
            tbody.innerHTML = '';

            // 6. Ranking de Produtos E Histﾃｳrico de Clientes
            const contagemProdutos = {};
            const historicoClientes = {}; // Para a Aba 3

            pedidos.forEach(p => {
                const data = new Date(p.created_at);
                const isEncomenda = p.address && p.address.includes('[套 ENCOMENDA:');
                let tipoBadge = `<span class="px-2 py-1 rounded text-[10px] font-bold ${p.delivery_type === 'entrega' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'} uppercase">${p.delivery_type}</span>`;
                if (isEncomenda) {
                    tipoBadge += ` <span class="px-2 py-1 rounded text-[10px] font-bold bg-orange-100 text-orange-700 uppercase ml-1"><i class="fas fa-calendar-check"></i> Encomenda</span>`;
                }

                // Injeta na tabela
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition cursor-pointer border-b border-gray-50" onclick="verPedidoDetalhe('${p.id}')">
                        <td class="px-6 py-4 font-bold text-gray-700">${data.toLocaleDateString('pt-BR')} <span class="text-gray-400 font-normal ml-1">${data.toLocaleTimeString().slice(0, 5)}</span></td>
                        <td class="px-6 py-4 font-medium">${p.customer_name}</td>
                        <td class="px-6 py-4">${tipoBadge}</td>
                        <td class="px-6 py-4 text-right font-black text-green-600">${fmtMoney(p.total_amount)}</td>
                        <td class="px-6 py-4 text-center"><button class="bg-gray-100 text-gray-500 w-8 h-8 rounded-full hover:bg-purple-100 hover:text-purple-600 transition"><i class="fas fa-chevron-right"></i></button></td>
                    </tr>
                `;

                // Popula Ranking de Produtos
                try {
                    const itens = JSON.parse(p.items);
                    itens.forEach(i => {
                        const nome = i.produto;
                        const qtd = Number(i.qtd);
                        const precoTotal = Number(i.preco) * qtd;

                        if (!contagemProdutos[nome]) {
                            contagemProdutos[nome] = { nome: nome, qtd: 0, receita: 0 };
                        }
                        contagemProdutos[nome].qtd += qtd;
                        contagemProdutos[nome].receita += precoTotal;
                    });
                } catch (e) { }

                // Popula Histﾃｳrico de Clientes
                const nomeCliente = p.customer_name || 'Desconhecido';
                if (!historicoClientes[nomeCliente]) {
                    historicoClientes[nomeCliente] = { nome: nomeCliente, qtdPedidos: 0, valorGasto: 0, ultimoPedido: data };
                }
                historicoClientes[nomeCliente].qtdPedidos++;
                historicoClientes[nomeCliente].valorGasto += Number(p.total_amount);
                if (data > historicoClientes[nomeCliente].ultimoPedido) {
                    historicoClientes[nomeCliente].ultimoPedido = data;
                }
            });

            // Converte e ordena Ranking de Produtos
            const rankingOrdenado = Object.values(contagemProdutos).sort((a, b) => b.qtd - a.qtd);
            const tbodyProdutos = document.getElementById('tabela-ranking-produtos');
            if (tbodyProdutos) {
                tbodyProdutos.innerHTML = '';
                if (rankingOrdenado.length === 0) {
                    tbodyProdutos.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400">Nenhum produto vendido neste perﾃｭodo.</td></tr>';
                } else {
                    rankingOrdenado.forEach((prod, index) => {
                        let medalha = `<span class="text-gray-400 font-black">${index + 1}ﾂｺ</span>`;
                        if (index === 0) medalha = `<i class="fas fa-trophy text-yellow-500 text-xl drop-shadow-md"></i>`;
                        if (index === 1) medalha = `<i class="fas fa-medal text-gray-400 text-lg"></i>`;
                        if (index === 2) medalha = `<i class="fas fa-medal text-amber-700 text-lg"></i>`;

                        tbodyProdutos.innerHTML += `
                            <tr class="hover:bg-gray-50 transition group border-b border-gray-50">
                                <td class="px-6 py-4 text-center align-middle">${medalha}</td>
                                <td class="px-6 py-4 font-bold text-gray-800">${prod.nome}</td>
                                <td class="px-6 py-4 text-center align-middle">
                                    <span class="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-black border border-blue-100 group-hover:bg-blue-600 group-hover:text-white transition">${prod.qtd}x</span>
                                </td>
                                <td class="px-6 py-4 text-right font-black text-green-600 align-middle">${fmtMoney(prod.receita)}</td>
                            </tr>
                        `;
                    });
                }
            }

            // Converte e Ordena Histﾃｳrico de Clientes (Aba 3)
            const clientesOrdenados = Object.values(historicoClientes).sort((a, b) => b.valorGasto - a.valorGasto);
            const abaClientes = document.getElementById('aba-clientes');

            if (abaClientes) {
                let htmlClientes = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-black text-gray-800">Clientes Mais Valiosos</h2>
                        <span class="text-xs font-bold text-gray-400 bg-gray-100 px-3 py-1 rounded-full"><i class="fas fa-filter"></i> Reflete o perﾃｭodo selecionado</span>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-600">
                                <thead class="bg-gray-50 text-[10px] uppercase font-bold text-gray-400 border-b border-gray-100">
                                    <tr>
                                        <th class="px-6 py-4">Cliente</th>
                                        <th class="px-6 py-4 text-center">Pedidos no Perﾃｭodo</th>
                                        <th class="px-6 py-4 text-center">ﾃ嗟timo Pedido</th>
                                        <th class="px-6 py-4 text-right">Valor Gasto</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50">
                `;

                if (clientesOrdenados.length === 0) {
                    htmlClientes += `<tr><td colspan="4" class="text-center py-8 text-gray-400">Nenhum cliente ativo neste perﾃｭodo.</td></tr>`;
                } else {
                    clientesOrdenados.forEach(cli => {
                        htmlClientes += `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 font-bold text-gray-800 flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-black text-xs uppercase">${cli.nome.charAt(0)}</div>
                                    ${cli.nome}
                                </td>
                                <td class="px-6 py-4 text-center font-bold text-gray-600">${cli.qtdPedidos}</td>
                                <td class="px-6 py-4 text-center text-xs text-gray-400">${cli.ultimoPedido.toLocaleDateString('pt-BR')}</td>
                                <td class="px-6 py-4 text-right font-black text-green-600">${fmtMoney(cli.valorGasto)}</td>
                            </tr>
                        `;
                    });
                }

                htmlClientes += `</tbody></table></div></div>`;
                abaClientes.innerHTML = htmlClientes;
            }
        } // <- FIM DA FUNﾃﾃグ processarDados()

        // --- MODAL DE DETALHES ---
        // --- MODAL DE DETALHES ---
        async function verPedidoDetalhe(id) {
            document.getElementById('modal-content').innerHTML = '<div class="text-center py-6 text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
            document.getElementById('modal-view').classList.remove('hidden');
            document.getElementById('modal-view').classList.add('flex');

            const { data: p } = await _supabase.from('orders').select('*').eq('id', id).single();
            if (!p) return;

            let itensHtml = '';
            try {
                const itemsParsed = JSON.parse(p.items);
                itemsParsed.forEach(i => {
                    itensHtml += `
                    <div class="flex justify-between text-xs py-2 border-b border-gray-100">
                        <span class="font-bold text-gray-700"><span class="bg-gray-200 px-1.5 rounded mr-1">${i.qtd}x</span> ${i.produto}</span>
                        <span class="text-gray-500">${fmtMoney(Number(i.preco) * Number(i.qtd))}</span>
                    </div>`;
                });
            } catch (e) { itensHtml = '<p class="text-xs text-red-400">Erro ao ler itens</p>'; }

            const html = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 text-xs">
                        <p class="mb-1"><strong class="text-gray-700">ID:</strong> #${p.id.split('-')[0].toUpperCase()}</p>
                        <p class="mb-1"><strong class="text-gray-700">Cliente:</strong> ${p.customer_name}</p>
                        <p class="mb-1"><strong class="text-gray-700">Endereﾃｧo:</strong> ${p.address}</p>
                        <p><strong class="text-gray-700">Pagamento:</strong> <span class="bg-yellow-100 text-yellow-800 px-2 rounded-md font-bold">${p.payment_method.toUpperCase()}</span></p>
                    </div>
                    
                    <div>
                        <p class="text-[10px] font-black uppercase text-gray-400 tracking-widest mb-2">Itens do Pedido</p>
                        <div class="max-h-40 overflow-y-auto custom-scroll pr-2">
                            ${itensHtml}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center bg-green-50 p-3 rounded-xl border border-green-100">
                        <span class="text-xs font-bold text-green-700 uppercase">Valor Total</span>
                        <span class="text-xl font-black text-green-700">${fmtMoney(p.total_amount)}</span>
                    </div>

                    <div class="pt-2">
                        <button onclick="imprimirPedido('${p.id}')" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 shadow-md active:scale-95">
                            <i class="fas fa-print"></i> Imprimir Pedido
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modal-content').innerHTML = html;
        }

        // --- FUNﾃﾃグ DE IMPRESSﾃグ VIA DASHBOARD ---
        window.imprimirPedido = async function (id) {
            const { data: p } = await _supabase.from('orders').select('*').eq('id', id).single();
            if (!p) return;

            let itensHtml = '';
            let subtotal = 0;
            try {
                const itens = JSON.parse(p.items);
                itens.forEach(i => {
                    const total = Number(i.preco) * Number(i.qtd);
                    subtotal += total;
                    itensHtml += `
                    <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:4px;">
                        <span>${i.qtd}x ${i.produto}</span>
                        <span>R$ ${total.toFixed(2)}</span>
                    </div>`;
                });
            } catch (e) { }

            // Limpa links gigantes do Pix para nﾃ｣o poluir a notinha
            let paymentClean = p.payment_method || "";
            paymentClean = paymentClean.replace(/(https?:\/\/[^\s]+)/g, "").replace("Link Comprovante:", "").trim();

            const dataPedido = new Date(p.created_at).toLocaleString('pt-BR');
            const totalFinal = Number(p.total_amount);
            const desconto = subtotal - totalFinal;

            let descontoHtml = '';
            if (desconto > 0.05) {
                descontoHtml = `
                <div style="display:flex; justify-content:space-between; margin-top:5px; border-top:1px dashed #000; paddingTop:5px;">
                    <span>Subtotal</span><span>${fmtMoney(subtotal)}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Desconto</span><span>- ${fmtMoney(desconto)}</span>
                </div>`;
            }

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = `
                <div style="text-align:center; font-weight:bold; font-size:16px;">ALFA SALGATERIA</div>
                <div style="text-align:center; margin-bottom:10px;">Pedido #${p.id.slice(0, 4).toUpperCase()}</div>
                <div style="border-bottom:1px dashed #000; margin-bottom:10px;"></div>
                
                <div><b>Data:</b> ${dataPedido}</div>
                <div><b>Cliente:</b> ${p.customer_name}</div>
                <div><b>End:</b> ${p.address}</div>
                <div><b>Pag:</b> ${paymentClean}</div>
                
                <div style="border-bottom:1px dashed #000; margin:10px 0;"></div>
                <div style="font-weight:bold; margin-bottom:5px;">ITENS:</div>
                ${itensHtml}
                
                ${descontoHtml}
                
                <div style="border-top:2px solid #000; margin-top:10px; padding-top:5px; display:flex; justify-content:space-between; font-size:18px; font-weight:bold;">
                    <span>TOTAL</span>
                    <span>${fmtMoney(totalFinal)}</span>
                </div>
                <div style="text-align:center; margin-top:20px; font-size:10px;">*** VIA DASHBOARD ***</div>
            `;

            window.print();
        };

        // --- RENDERIZADOR DE GRﾃ：ICOS (Chart.js) ---
        function renderChart(id, ctx, type, data, label, colors, labels) {
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels || (type === 'bar' ? Array.from({ length: 24 }, (_, i) => `${i}h`) : []),
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: colors,
                        borderColor: type === 'line' ? colors[0] : 'transparent',
                        borderWidth: type === 'line' ? 3 : 0,
                        tension: 0.4, // Curva suave para linhas
                        fill: type === 'line' ? { target: 'origin', above: 'rgba(234, 88, 12, 0.1)' } : false, // Fundo leve sob a linha
                        borderRadius: type === 'bar' ? 4 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type === 'doughnut', position: 'right' }
                    },
                    scales: type !== 'doughnut' ? {
                        y: { beginAtZero: true, grid: { borderDash: [5, 5], color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    } : {}
                }
            });
        }

        // Inicia o sistema
        document.addEventListener('DOMContentLoaded', () => {
            carregarRelatorios('hoje'); // Inicia carregando os dados de hoje
        });
    </script>
</body>

</html>