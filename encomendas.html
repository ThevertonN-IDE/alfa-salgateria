<!DOCTYPE html>
<html lang="pt-br" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ea580c">
    <title>Encomendas | Alfa Salgateria</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="data.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { alfa: { 500: '#ea580c', 600: '#c2410c' } },
                    zIndex: { '100': '100', '110': '110' }
                }
            }
        }
    </script>

    <style>
        /* --- RESET GERAL E CSS REAPROVEITADO DO INDEX --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .header-bg {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
        }

        .dark .header-bg {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }

        .bg-pattern-light {
            background-color: #f8fafc;
            background-image: radial-gradient(#ea580c 0.5px, transparent 0.5px);
            background-size: 24px 24px;
        }

        .glass {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .animate-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .force-white-light {
            background-color: #ffffff !important;
            color: #1f2937 !important;
        }

        .dark .force-white-light {
            background-color: #111827 !important;
            color: #f3f4f6 !important;
        }

        /* Estiliza√ß√£o extra para inputs de data/hora no tema escuro */
        /* Truque Pro para o calend√°rio: esconde o √≠cone feio e deixa o campo 100% clic√°vel */
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            color: transparent;
            background: transparent;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>

<body
    class="bg-pattern-light text-gray-800 transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100 flex flex-col min-h-screen">

    <header class="header-bg text-white h-16 shadow-lg sticky top-0 z-50 flex items-center justify-between px-4">
        <button onclick="window.location.href='index.html'"
            class="w-10 h-10 rounded-full flex items-center justify-center hover:bg-white/20 transition active:scale-95">
            <i class="fas fa-arrow-left text-xl"></i>
        </button>

        <div class="flex items-center gap-3">
            <div
                class="w-10 h-10 bg-white rounded-full p-0.5 shadow-md overflow-hidden border-2 border-white/40 relative flex items-center justify-center text-orange-600 font-black text-[9px]">
                ALFA
            </div>
            <span class="font-black text-lg tracking-tight uppercase text-shadow">ENCOMENDAS</span>
        </div>

        <div class="w-10"></div>
    </header>

    <div id="status-bar"
        class="bg-orange-100 dark:bg-orange-500/20 border-b border-orange-200 dark:border-orange-500/30 px-4 py-2 flex items-center justify-center gap-2 text-xs font-bold text-orange-600 dark:text-orange-400 shadow-sm animate-pulse">
        <i class="fas fa-clock"></i> Carregando hor√°rios dispon√≠veis...
    </div>

    <main class="p-5 space-y-6 flex-grow min-h-[50vh] max-w-2xl mx-auto w-full">

        <div
            class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-[2rem] border border-gray-100 dark:border-gray-700 shadow-lg animate-up relative overflow-hidden mb-8">
            <div
                class="absolute -right-12 -top-12 w-40 h-40 bg-orange-500/10 rounded-full blur-3xl pointer-events-none">
            </div>

            <div class="relative z-10">
                <div class="flex items-center gap-4 mb-6">
                    <div
                        class="w-12 h-12 rounded-2xl bg-gradient-to-br from-orange-400 to-orange-600 text-white flex items-center justify-center shadow-md flex-shrink-0">
                        <i class="fas fa-calendar-check text-xl"></i>
                    </div>
                    <div>
                        <h2 class="font-black text-xl text-gray-800 dark:text-white leading-tight">Agende sua Retirada
                        </h2>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 font-medium">Quando a sua festa vai
                            acontecer?</p>
                    </div>
                </div>

                <div
                    class="bg-gray-50 dark:bg-gray-900/50 p-5 rounded-2xl border border-gray-100 dark:border-gray-800 flex flex-col sm:flex-row gap-5">

                    <div class="flex-1 relative">
                        <label
                            class="text-[9px] font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest mb-2 block ml-1">Data</label>
                        <div class="relative group">
                            <div
                                class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-orange-500 z-0">
                                <i
                                    class="far fa-calendar-alt text-lg group-hover:scale-110 transition-transform duration-300"></i>
                            </div>
                            <input type="date" id="data-encomenda" onchange="atualizarHorarios()"
                                class="w-full relative bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white text-sm sm:text-base font-bold rounded-xl focus:ring-0 focus:border-orange-500 focus:bg-white dark:focus:bg-gray-800 block pl-12 pr-4 py-3.5 outline-none transition-all shadow-sm hover:border-orange-300 cursor-pointer">
                        </div>
                    </div>

                    <div class="flex-1 relative">
                        <label
                            class="text-[9px] font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest mb-2 block ml-1">Hor√°rio</label>
                        <div class="relative group">
                            <div
                                class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-orange-500 z-10">
                                <i
                                    class="far fa-clock text-lg group-hover:scale-110 transition-transform duration-300"></i>
                            </div>
                            <select id="hora-encomenda"
                                class="w-full appearance-none bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-white text-sm sm:text-base font-bold rounded-xl focus:ring-0 focus:border-orange-500 focus:bg-white dark:focus:bg-gray-800 block pl-12 pr-10 py-3.5 outline-none transition-all shadow-sm hover:border-orange-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                                <option value="">Selecione a data...</option>
                            </select>
                            <div
                                class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-gray-400">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="lista-encomendas" class="space-y-4">

            <div id="vazio-encomenda"
                class="flex-col items-center justify-center text-center py-12 opacity-80 animate-up flex">
                <div
                    class="bg-gray-100 dark:bg-gray-800 w-20 h-20 rounded-full flex items-center justify-center mb-4 border border-gray-200 dark:border-gray-700 shadow-inner">
                    <i class="fas fa-box-open text-3xl text-gray-400 dark:text-gray-500"></i>
                </div>
                <p class="text-lg font-black text-gray-700 dark:text-white mb-2">Nenhum item adicionado</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 max-w-[250px]">Adicione os produtos que deseja
                    encomendar atrav√©s do nosso card√°pio principal.</p>

                <button onclick="window.location.href='index.html'"
                    class="mt-8 bg-orange-100 dark:bg-orange-500/10 text-orange-600 dark:text-orange-500 font-bold text-xs uppercase tracking-wide px-6 py-3 rounded-xl border border-orange-200 dark:border-orange-500/30 hover:bg-orange-200 dark:hover:bg-orange-500/20 transition active:scale-95">
                    Voltar ao Card√°pio
                </button>
            </div>

        </div>

    </main>

    <footer
        class="mt-auto py-8 text-center border-t border-gray-200 dark:border-gray-800 bg-white/50 dark:bg-gray-900/50 glass">
        <p class="text-xs font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest mb-1">Alfa Salgateria ¬©
            2026</p>
        <p class="text-[10px] text-gray-300 dark:text-gray-600">v1.4.0 ‚Ä¢ Desenvolvido por Theverton</p>
    </footer>
    <div id="barra-encomenda"
        class="fixed bottom-5 left-5 right-5 bg-gray-900 dark:bg-orange-600 text-white p-4 rounded-3xl shadow-2xl z-30 hidden items-center justify-between transition-transform duration-300 translate-y-32 cursor-pointer active:scale-95 max-w-2xl mx-auto"
        onclick="abrirResumoEnc()">
        <div class="flex flex-col pl-2">
            <span class="text-[9px] opacity-70 uppercase tracking-widest font-bold">Total da Encomenda</span>
            <span id="total-barra-enc" class="text-xl font-black">R$ 0,00</span>
        </div>
        <div class="flex items-center gap-2 font-bold text-xs bg-white/20 px-4 py-2.5 rounded-2xl backdrop-blur-sm">
            Ver Pedido <span id="qtd-badge-enc"
                class="bg-white text-gray-900 text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-black">0</span>
        </div>
    </div>

    <div id="modal-resumo-enc"
        class="fixed inset-0 bg-black/60 z-[100] hidden items-end transition-opacity opacity-0 backdrop-blur-sm"
        onclick="if(event.target === this) fecharResumoEnc()">
        <div
            class="force-white-light w-full max-w-2xl mx-auto rounded-t-[2.5rem] p-6 animate-up max-h-[90vh] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="font-black text-2xl">Sua Encomenda</h3>
                    <p id="resumo-data-hora" class="text-xs font-bold text-orange-500 mt-1 uppercase tracking-wide"></p>
                </div>
                <button onclick="fecharResumoEnc()"
                    class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center text-gray-500 transition hover:bg-gray-200"><i
                        class="fas fa-times"></i></button>
            </div>
            <div id="lista-itens-resumo-enc" class="flex-grow overflow-y-auto custom-scroll space-y-4 mb-6 pr-2"></div>
            <div class="border-t border-gray-100 dark:border-gray-700 pt-6">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-gray-500 dark:text-gray-400 font-bold">Total Estimado</span>
                    <span id="total-resumo-enc" class="text-3xl font-black text-orange-600 dark:text-orange-500">R$
                        0,00</span>
                </div>
                <div class="grid grid-cols-[1fr_2fr] gap-4">
                    <button onclick="limparCarrinhoEnc()"
                        class="bg-red-50 dark:bg-red-900/20 text-red-500 py-4 rounded-2xl font-bold text-sm hover:bg-red-100 transition flex items-center justify-center gap-2"><i
                            class="fas fa-trash-alt"></i> Tudo</button>
                    <button onclick="avancarParaCheckout()"
                        class="bg-green-600 text-white py-4 rounded-2xl font-black text-base shadow-xl shadow-green-200 dark:shadow-none hover:bg-green-700 active:scale-95 transition uppercase tracking-wide flex items-center justify-center gap-2">Continuar
                        <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </div>
    <script>
        if (localStorage.getItem('tema') === 'dark') document.documentElement.classList.add('dark');

        let produtosEncomenda = [];
        let carrinhoEncomenda = {};
        let configLoja = {}; // <--- Vari√°vel nova para guardar as configs

        async function carregarEncomendas() {
            try {
                // Busca os produtos e as configura√ß√µes da loja AO MESMO TEMPO
                const [reqProdutos, reqConfig] = await Promise.all([
                    _supabase.from('products').select('*').eq('active', true).order('order_index'),
                    _supabase.from('store_config').select('*').limit(1)
                ]);

                if (reqProdutos.error) throw reqProdutos.error;

                const data = reqProdutos.data;
                configLoja = reqConfig.data?.[0] || {}; // Salva a config para usar nos hor√°rios

                // TRAVA DE SEGURAN√áA (CHAVE MESTRA DO SaaS)
                if (configLoja.schedule_config && configLoja.schedule_config.ativo === false) {
                    return Swal.fire({
                        title: 'Pausa nas Encomendas',
                        text: 'Nossa agenda est√° fechada no momento. Volte em breve!',
                        icon: 'info',
                        confirmButtonColor: '#ea580c',
                        allowOutsideClick: false
                    }).then(() => window.location.href = 'index.html');
                }

                // Filtra o que vai aparecer na tela de encomendas
                produtosEncomenda = data.filter(p => {
                    let vars = [];
                    try { if (p.variants) vars = typeof p.variants === 'string' ? JSON.parse(p.variants) : p.variants; } catch (e) { }

                    if (vars.length > 0) {
                        return vars.some(v => !v.type || v.type === 'ambos' || v.type === 'encomenda');
                    }
                    return p.for_encomenda === true;
                });

                const statusBar = document.getElementById('status-bar');
                if (statusBar) {
                    statusBar.classList.remove('animate-pulse', 'bg-orange-100', 'text-orange-600', 'dark:bg-orange-500/20', 'dark:text-orange-400');
                    statusBar.classList.add('bg-green-100', 'text-green-700', 'dark:bg-green-500/20', 'dark:text-green-400', 'border-green-200', 'dark:border-green-500/30');
                    statusBar.innerHTML = '<i class="fas fa-check-circle"></i> Cat√°logo atualizado';
                    setTimeout(() => statusBar.style.display = 'none', 2000);
                }

                if (document.getElementById('skeleton')) {
                    document.getElementById('skeleton').classList.add('hidden');
                }

                renderizarEncomendas();

                // Ativa a trava do calend√°rio logo ap√≥s carregar tudo
                configurarCalendario();

            } catch (err) {
                console.error("Erro ao carregar:", err);
                Swal.fire('Erro', 'Falha ao carregar cat√°logo.', 'error');
            }
        }

        function renderizarEncomendas() {
            const container = document.getElementById('lista-encomendas');
            const vazio = document.getElementById('vazio-encomenda');

            if (produtosEncomenda.length === 0) {
                vazio.classList.remove('hidden');
                vazio.classList.add('flex');
                return;
            }

            vazio.classList.add('hidden');
            vazio.classList.remove('flex');
            let html = '';

            produtosEncomenda.forEach(p => {
                const img = p.image_url || 'https://placehold.co/100?text=Foto';
                let vars = [];
                try { if (p.variants) vars = typeof p.variants === 'string' ? JSON.parse(p.variants) : p.variants; } catch (e) { }

                // Pega S√ì as varia√ß√µes que podem aparecer na encomenda
                let validVars = vars.filter(v => !v.type || v.type === 'ambos' || v.type === 'encomenda');
                const hasVar = validVars.length > 0;

                let priceHTML = '', actionHTML = '', varsHTML = '';

                if (hasVar) {
                    const min = Math.min(...validVars.map(v => v.promo_price || v.price));
                    priceHTML = `<span class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">A partir de <span class="text-orange-600 dark:text-orange-500 font-black text-base">R$ ${min.toFixed(2)}</span></span>`;
                    actionHTML = `<button onclick="toggleComboEnc('${p.id}')" id="btn-combo-${p.id}" class="bg-white dark:bg-gray-700 text-orange-600 dark:text-white px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-orange-50 transition shadow-sm border border-orange-200 dark:border-gray-600">Ver Op√ß√µes <i class="fas fa-chevron-down ml-1"></i></button>`;

                    let optsHTML = validVars.map(v => {
                        const originalIndex = vars.indexOf(v); // Guarda o ID original da varia√ß√£o
                        const price = v.promo_price || v.price;
                        const oldP = v.promo_price ? `<span class="text-[10px] line-through text-gray-400 mr-2">R$${Number(v.price).toFixed(2)}</span>` : '';

                        return `
                        <label onclick="selecionarOpcao(this)" class="flex justify-between opcao-item items-center p-3.5 rounded-xl cursor-pointer relative overflow-hidden mb-2 transition hover:border-orange-200 group shadow-sm bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 radio-box">
                            <input type="radio" name="v_${p.id}" value="${originalIndex}" class="peer sr-only radio-box">
                            <span class="text-xs font-bold text-gray-700 dark:text-gray-300 z-10 flex items-center gap-2"><i class="fas fa-utensils opacity-50 text-[10px]"></i> ${v.qtd}</span>
                            <div class="text-right z-10 flex items-center">${oldP}<span class="font-black text-sm text-gray-800 dark:text-white">R$ ${Number(price).toFixed(2)}</span></div>
                            <i class="fas fa-check-circle text-orange-500 absolute right-3 opacity-0 transition transform scale-0 check-icon"></i>
                        </label>`;
                    }).join('');

                    varsHTML = `<div id="area-${p.id}" class="hidden mt-4 pt-4 border-t border-dashed border-orange-200 dark:border-gray-700 animate-up"><p class="text-[10px] font-black text-gray-400 uppercase mb-3 ml-1 tracking-wider">Selecione:</p>${optsHTML}<button onclick="addComboEnc('${p.id}')" class="w-full mt-4 bg-gray-900 dark:bg-orange-600 text-white py-3.5 rounded-xl font-black text-xs shadow-lg active:scale-95 transition hover:bg-black uppercase tracking-wide flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Adicionar √† Encomenda</button></div>`;

                } else {
                    const pr = p.on_sale ? p.sale_price : p.price;
                    const old = p.on_sale ? `<span class="text-[10px] text-gray-400 line-through mr-1">R$${p.price.toFixed(2)}</span>` : '';
                    priceHTML = `<div>${old}<span class="text-xl font-black text-orange-600 dark:text-orange-500">R$ ${Number(pr).toFixed(2)}</span></div>`;
                    actionHTML = `<div class="flex items-center bg-gray-100 dark:bg-gray-700 rounded-xl p-1 shadow-inner border border-gray-200 dark:border-gray-600"><button onclick="addEnc('${p.id}',-1)" class="w-9 h-9 flex items-center justify-center text-gray-400 font-bold hover:text-red-500 active:scale-90 transition rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">-</button><span id="qtd-enc-${p.id}" class="w-8 text-center text-base font-bold dark:text-white">0</span><button onclick="addEnc('${p.id}',1)" class="w-9 h-9 flex items-center justify-center bg-white dark:bg-gray-600 text-green-600 rounded-lg shadow-sm font-bold hover:bg-green-50 active:scale-90 transition">+</button></div>`;
                }

                html += `
                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm animate-up flex flex-col mb-4 relative overflow-hidden">
                    <div class="flex gap-4">
                        <div class="w-20 h-20 bg-gray-50 dark:bg-gray-700 rounded-xl overflow-hidden flex-shrink-0 border border-gray-100 dark:border-gray-600 relative"><img src="${img}" class="w-full h-full object-cover"></div>
                        <div class="flex-grow flex flex-col justify-between"><div><h3 class="font-black text-sm text-gray-800 dark:text-white">${p.name}</h3><p class="text-[11px] text-gray-500 dark:text-gray-400 line-clamp-2 mt-0.5 leading-tight">${p.description || 'Produto sob encomenda'}</p></div><div class="flex justify-between items-end mt-2">${priceHTML}${actionHTML}</div></div>
                    </div>
                    ${varsHTML}
                </div>`;
            });

            const cardsContainer = document.createElement('div');
            cardsContainer.innerHTML = html;
            container.appendChild(cardsContainer);
        }

        window.toggleComboEnc = function (id) {
            const area = document.getElementById(`area-${id}`);
            const btn = document.getElementById(`btn-combo-${id}`);
            area.classList.toggle('hidden');
            if (area.classList.contains('hidden')) {
                btn.innerHTML = `Ver Op√ß√µes <i class="fas fa-chevron-down ml-1"></i>`;
                btn.classList.remove('bg-orange-100', 'text-orange-700', 'border-orange-200');
            } else {
                btn.innerHTML = `Ocultar <i class="fas fa-chevron-up ml-1"></i>`;
                btn.classList.add('bg-orange-100', 'text-orange-700', 'border-orange-200');
            }
        }

        window.selecionarOpcao = function (elementoClicado) {
            const todasAsOpcoes = elementoClicado.parentElement.querySelectorAll('.opcao-item');
            todasAsOpcoes.forEach(opcao => {
                opcao.classList.remove('border-orange-500', 'bg-orange-500/10', 'dark:border-orange-500');
                opcao.classList.add('border-gray-700', 'dark:border-gray-600');
            });
            elementoClicado.classList.remove('border-gray-700', 'dark:border-gray-600');
            elementoClicado.classList.add('border-orange-500', 'bg-orange-500/10', 'dark:border-orange-500');
        }

        // --- SISTEMA REAL DE CARRINHO DE ENCOMENDAS ---
        const KEY_CART_ENC = 'carrinho_encomenda_v1';

        // Substitua as fun√ß√µes addEnc e addComboEnc antigas por estas:
        window.addEnc = function (id, d) {
            const k = String(id);
            if (!carrinhoEncomenda[k]) carrinhoEncomenda[k] = 0;
            carrinhoEncomenda[k] += d;
            if (carrinhoEncomenda[k] <= 0) delete carrinhoEncomenda[k];

            const el = document.getElementById(`qtd-enc-${id}`);
            if (el) el.innerText = carrinhoEncomenda[k] || 0;

            salvarCarrinhoEnc();
            if (d > 0) Swal.fire({ toast: true, position: 'bottom', title: 'Adicionado √† Encomenda', icon: 'success', showConfirmButton: false, timer: 1000, background: '#22c55e', color: 'white' });
        }

        window.addComboEnc = function (id) {
            const r = document.querySelector(`input[name="v_${id}"]:checked`);
            if (!r) return Swal.fire({ toast: true, title: 'Selecione uma op√ß√£o', icon: 'warning', showConfirmButton: false, timer: 1500 });

            const k = `${id}__${r.value}`;
            if (!carrinhoEncomenda[k]) carrinhoEncomenda[k] = 0;
            carrinhoEncomenda[k]++;

            salvarCarrinhoEnc();
            Swal.fire({ toast: true, title: 'Op√ß√£o adicionada!', icon: 'success', position: 'bottom', showConfirmButton: false, timer: 1000, background: '#22c55e', color: 'white' });
            r.checked = false;
            toggleComboEnc(id);
        }

        function salvarCarrinhoEnc() {
            localStorage.setItem(KEY_CART_ENC, JSON.stringify(carrinhoEncomenda));
            atualizarBarraEnc();
        }

        function atualizarBarraEnc() {
            let t = 0, q = 0;
            for (const [k, v] of Object.entries(carrinhoEncomenda)) {
                const [pid, vIdx] = k.split('__');
                const p = produtosEncomenda.find(x => String(x.id) === String(pid));
                if (p) {
                    let price = p.on_sale ? p.sale_price : p.price;
                    if (vIdx !== undefined) {
                        try { const vars = (typeof p.variants === 'string') ? JSON.parse(p.variants) : p.variants; if (vars[vIdx]) price = vars[vIdx].promo_price || vars[vIdx].price; } catch (e) { }
                    }
                    t += Number(price) * v; q += v;
                }
            }
            const b = document.getElementById('barra-encomenda');
            if (q > 0) {
                b.classList.remove('hidden'); setTimeout(() => b.classList.remove('translate-y-32'), 10);
                document.getElementById('total-barra-enc').innerText = `R$ ${t.toFixed(2).replace('.', ',')}`;
                document.getElementById('qtd-badge-enc').innerText = q;
            } else { b.classList.add('translate-y-32'); setTimeout(() => b.classList.add('hidden'), 300); }
        }

        // --- FUN√á√ïES DO MODAL DE RESUMO ---
        window.abrirResumoEnc = function () {
            // VALIDA√á√ÉO: Verifica se preencheu data e hora
            const dataEnc = document.getElementById('data-encomenda').value;
            const horaEnc = document.getElementById('hora-encomenda').value;

            if (!dataEnc || !horaEnc) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return Swal.fire('Aten√ß√£o', 'Por favor, informe a Data e o Hor√°rio da encomenda antes de ver o resumo.', 'warning');
            }

            // Formata a data para mostrar no topo do modal
            const dataFormatada = dataEnc.split('-').reverse().join('/');
            document.getElementById('resumo-data-hora').innerHTML = `<i class="far fa-calendar-check"></i> ${dataFormatada} √†s ${horaEnc}`;

            document.getElementById('modal-resumo-enc').classList.remove('hidden');
            document.getElementById('modal-resumo-enc').classList.add('flex');
            setTimeout(() => document.getElementById('modal-resumo-enc').classList.remove('opacity-0'), 10);
            renderizarResumoEnc();
        }

        window.fecharResumoEnc = function () {
            document.getElementById('modal-resumo-enc').classList.add('opacity-0');
            setTimeout(() => { document.getElementById('modal-resumo-enc').classList.add('hidden'); document.getElementById('modal-resumo-enc').classList.remove('flex'); }, 300);
        }

        function renderizarResumoEnc() {
            const l = document.getElementById('lista-itens-resumo-enc'); l.innerHTML = ''; let t = 0;
            for (const [k, q] of Object.entries(carrinhoEncomenda)) {
                const [pid, vIdx] = k.split('__'); const p = produtosEncomenda.find(x => String(x.id) === String(pid));
                if (p) {
                    let n = p.name, pr = p.on_sale ? p.sale_price : p.price;
                    if (vIdx !== undefined) { try { const vs = (typeof p.variants === 'string') ? JSON.parse(p.variants) : p.variants; if (vs[vIdx]) { n += ` (${vs[vIdx].qtd})`; pr = vs[vIdx].promo_price || vs[vIdx].price; } } catch (e) { } }
                    const sub = Number(pr) * q; t += sub;
                    l.innerHTML += `
                    <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 animate-up">
                        <div class="flex items-center gap-3">
                            <div class="bg-orange-100 text-orange-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm shadow-inner">${q}x</div>
                            <p class="font-bold text-sm text-gray-700 dark:text-white">${n}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <p class="font-black text-sm text-gray-800 dark:text-white">R$ ${sub.toFixed(2)}</p>
                            <button onclick="removerItemEnc('${k}')" class="w-8 h-8 bg-red-50 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center hover:bg-red-100 transition shadow-sm"><i class="fas fa-trash-alt text-xs"></i></button>
                        </div>
                    </div>`;
                }
            }
            document.getElementById('total-resumo-enc').innerText = `R$ ${t.toFixed(2).replace('.', ',')}`;
        }

        window.removerItemEnc = function (key) {
            delete carrinhoEncomenda[key];
            salvarCarrinhoEnc();
            if (Object.keys(carrinhoEncomenda).length === 0) window.fecharResumoEnc();
            else renderizarResumoEnc();
        }

        window.limparCarrinhoEnc = function () {
            Swal.fire({ title: 'Limpar encomenda?', text: "Vai remover todos os itens.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ea580c', cancelButtonColor: '#d33', confirmButtonText: 'Sim' }).then((result) => {
                if (result.isConfirmed) { carrinhoEncomenda = {}; localStorage.removeItem(KEY_CART_ENC); location.reload(); }
            });
        }

        window.avancarParaCheckout = function () {
            // Salva as informa√ß√µes da data para puxarmos na tela de checkout
            const dadosAgendamento = {
                data: document.getElementById('data-encomenda').value,
                hora: document.getElementById('hora-encomenda').value,
                tipo: 'encomenda'
            };
            localStorage.setItem('dados_agendamento', JSON.stringify(dadosAgendamento));

            // Aqui ele vai para a tela de checkout (vamos ajustar a checkout.html depois para entender que √© encomenda)
            window.location.href = 'checkout.html?tipo=encomenda';
        }
        // Garante que a barra n√£o pisque vazia na tela
        atualizarBarraEnc();
        // --- INTELIG√äNCIA DE AGENDAMENTO ---
        function configurarCalendario() {
            const inputData = document.getElementById('data-encomenda');
            if(!inputData) return;
            
            // Puxa o limite de dias do Admin (padr√£o √© 30 se der erro)
            let diasMaximos = 30;
            if (configLoja && configLoja.schedule_config && configLoja.schedule_config.dias_maximos) {
                diasMaximos = parseInt(configLoja.schedule_config.dias_maximos);
            }
            
            const hoje = new Date();
            const yyyy = hoje.getFullYear();
            const mm = String(hoje.getMonth() + 1).padStart(2, '0');
            const dd = String(hoje.getDate()).padStart(2, '0');
            const hojeFormatado = `${yyyy}-${mm}-${dd}`;
            
            const futura = new Date();
            futura.setDate(futura.getDate() + diasMaximos);
            const futuraFormatado = `${futura.getFullYear()}-${String(futura.getMonth() + 1).padStart(2, '0')}-${String(futura.getDate()).padStart(2, '0')}`;
            
            inputData.min = hojeFormatado;
            inputData.max = futuraFormatado;
        }

        window.atualizarHorarios = function() {
            const selectHora = document.getElementById('hora-encomenda');
            const dataEscolhida = document.getElementById('data-encomenda').value;
            
            if(!dataEscolhida) {
                selectHora.innerHTML = '<option value="">Selecione a data...</option>';
                selectHora.disabled = true;
                return;
            }

            // Puxa as configura√ß√µes do Admin
            let horaInicio = "08:00";
            let horaFim = "18:00";
            let antecedenciaHoras = 1;
            let diasAtivos = [0, 1, 2, 3, 4, 5, 6]; // Por padr√£o, aceita todos
            
            if(configLoja && configLoja.schedule_config) {
                horaInicio = configLoja.schedule_config.inicio || "08:00";
                horaFim = configLoja.schedule_config.fim || "18:00";
                antecedenciaHoras = parseInt(configLoja.schedule_config.antecedencia) || 1;
                if (configLoja.schedule_config.dias_funcionamento) {
                    diasAtivos = configLoja.schedule_config.dias_funcionamento;
                }
            }

            // VALIDA√á√ÉO DO DIA DA SEMANA
            // Converte a data escolhida garantindo que n√£o d√™ bug de fuso hor√°rio
            const [ano, mes, dia] = dataEscolhida.split('-');
            const dataObj = new Date(ano, mes - 1, dia);
            const diaDaSemana = dataObj.getDay();

            // Se o dia n√£o estiver no array de dias ativos, bloqueia!
            if (!diasAtivos.includes(diaDaSemana)) {
                selectHora.innerHTML = '<option value="">üö´ Fechado neste dia</option>';
                selectHora.disabled = true; // Desabilita a caixinha
                selectHora.classList.add('text-red-500'); // Fica vermelho pro cliente ver
                return; // Para o c√≥digo aqui
            } else {
                selectHora.disabled = false;
                selectHora.classList.remove('text-red-500');
            }

            selectHora.innerHTML = '<option value="">Selecione o hor√°rio...</option>';
            
            let atual = new Date(`2000-01-01T${horaInicio}`);
            const limite = new Date(`2000-01-01T${horaFim}`);

            const hojeData = new Date();
            const isHoje = dataEscolhida === `${hojeData.getFullYear()}-${String(hojeData.getMonth()+1).padStart(2,'0')}-${String(hojeData.getDate()).padStart(2,'0')}`;

            while (atual <= limite) {
                let h = String(atual.getHours()).padStart(2, '0');
                let m = String(atual.getMinutes()).padStart(2, '0');
                
                if (isHoje) {
                    const agora = new Date();
                    const horaAgendamento = new Date();
                    horaAgendamento.setHours(atual.getHours(), atual.getMinutes(), 0);
                    
                    agora.setMinutes(agora.getMinutes() + (antecedenciaHoras * 60)); 
                    
                    if (horaAgendamento > agora) {
                        selectHora.innerHTML += `<option value="${h}:${m}">${h}:${m}</option>`;
                    }
                } else {
                    selectHora.innerHTML += `<option value="${h}:${m}">${h}:${m}</option>`;
                }
                
                atual.setMinutes(atual.getMinutes() + 30);
            }

            if (selectHora.options.length === 1) {
                selectHora.innerHTML = '<option value="">Nenhum hor√°rio disp. hoje</option>';
                selectHora.disabled = true;
            }
        }
        document.addEventListener('DOMContentLoaded', carregarEncomendas);
    </script>
</body>

</html>