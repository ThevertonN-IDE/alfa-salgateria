<!DOCTYPE html>
<html lang="pt-br" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Encomendas - Alfa Salgateria</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="data.js"></script>
    <script src="utils.js"></script>
    <script src="ui.js"></script>
    
    <style> body { font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; } </style>
</head>
<body class="bg-orange-50 dark:bg-gray-900 text-gray-800 dark:text-white pb-36 select-none flex flex-col min-h-screen transition-colors duration-300">

    <header class="bg-orange-600 dark:bg-gray-800 pb-8 rounded-b-3xl shadow-lg sticky top-0 z-40 transition-colors duration-300">
        <div class="px-4 pt-6 flex justify-between items-center text-white">
            <a href="index.html" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition backdrop-blur-md">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="text-right">
                <h1 class="text-xl font-black uppercase tracking-wider text-orange-100">Encomendas</h1>
                <p class="text-[10px] text-orange-200 font-bold uppercase">Agende sua festa</p>
            </div>
        </div>
        <div class="px-4 mt-4">
            <div id="aviso-agenda" class="bg-white/10 border border-white/20 p-3 rounded-xl text-xs text-orange-50 text-center font-medium backdrop-blur-sm">
                <i class="fas fa-clock mr-1"></i> Carregando horÃ¡rios disponÃ­veis...
            </div>
        </div>
    </header>

    <main id="conteudo-encomenda" class="max-w-md mx-auto p-4 space-y-4 flex-grow w-full">
        <div id="lista-produtos" class="space-y-4"></div>
    </main>

    <div id="barra-pedido" class="fixed bottom-0 inset-x-0 bg-white dark:bg-gray-800 p-4 shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-40 rounded-t-3xl hidden flex justify-between items-center transition-all duration-300 translate-y-full border-t border-gray-100 dark:border-gray-700 pb-8">
        <div class="flex items-center gap-3">
            <button onclick="limparCarrinho()" class="w-10 h-10 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center hover:bg-red-200 transition active:scale-90 shadow-sm" title="Esvaziar Carrinho">
                <i class="fas fa-trash-alt text-sm"></i>
            </button>
            <div>
                <p class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Total Previsto</p>
                <p id="total-barra" class="text-2xl font-black text-orange-600 dark:text-orange-500">R$ 0,00</p>
            </div>
        </div>
        <button onclick="abrirCheckoutEncomenda()" class="bg-orange-600 text-white px-8 py-3 rounded-2xl font-bold hover:bg-orange-700 active:scale-95 transition shadow-lg shadow-orange-200 dark:shadow-none text-sm flex items-center gap-2">
            AGENDAR <i class="fas fa-calendar-check ml-1"></i>
        </button>
    </div>

    <div id="modal-encomenda" class="fixed inset-0 bg-black/80 z-[60] hidden flex justify-end flex-col backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-gray-900 w-full h-[90vh] rounded-t-[2.5rem] p-6 overflow-y-auto animate-up shadow-2xl relative">
            <button onclick="document.getElementById('modal-encomenda').classList.add('hidden')" class="absolute top-5 right-5 bg-gray-100 dark:bg-gray-800 w-10 h-10 rounded-full text-gray-500 font-bold hover:bg-gray-200 dark:hover:bg-gray-700 transition flex items-center justify-center shadow-sm"><i class="fas fa-times"></i></button>
            
            <h2 class="text-2xl font-black text-orange-600 dark:text-orange-500 mb-6 uppercase flex items-center gap-2 tracking-tight"><i class="fas fa-calendar-alt"></i> Finalizar</h2>

            <div class="space-y-6 mb-24">
                
                <div class="bg-gray-100 dark:bg-gray-800 p-1.5 rounded-2xl flex gap-1 shadow-inner">
                    <button onclick="mudarTipoEntrega('retirada')" id="btn-tipo-retirada" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all bg-white dark:bg-gray-700 text-gray-800 dark:text-white shadow-sm border border-gray-200 dark:border-gray-600">
                        ðŸ¥¡ VOU RETIRAR
                    </button>
                    <button onclick="mudarTipoEntrega('entrega')" id="btn-tipo-entrega" class="flex-1 py-3 rounded-xl text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white">
                        ðŸ›µ PARA ENTREGA
                    </button>
                </div>

                <div id="box-endereco-entrega" class="hidden bg-orange-50 dark:bg-gray-800 p-5 rounded-2xl border border-orange-100 dark:border-gray-700 space-y-3 animate-fade">
                    <p class="text-[10px] font-bold text-orange-600 dark:text-orange-400 uppercase"><i class="fas fa-map-marker-alt mr-1"></i> EndereÃ§o de Entrega</p>
                    <select id="sel-bairro-encomenda" onchange="verificarSinal()" class="w-full bg-white dark:bg-gray-900 text-gray-800 dark:text-white p-3.5 rounded-xl border border-gray-200 dark:border-gray-700 text-sm outline-none focus:border-orange-500 font-medium appearance-none">
                        <option value="0">Selecione o Bairro...</option>
                        </select>
                    
                    <div class="grid grid-cols-4 gap-2">
                        <input type="text" id="input-rua-encomenda" onkeyup="verificarSinal()" placeholder="Logradouro (Rua/Av.)" class="col-span-3 w-full bg-white dark:bg-gray-900 text-gray-800 dark:text-white p-3.5 rounded-xl border border-gray-200 dark:border-gray-700 text-sm outline-none focus:border-orange-500 font-medium">
                        <input type="text" id="input-numero-encomenda" onkeyup="verificarSinal()" placeholder="NÂº" class="col-span-1 w-full bg-white dark:bg-gray-900 text-gray-800 dark:text-white p-3.5 rounded-xl border border-gray-200 dark:border-gray-700 text-sm outline-none focus:border-orange-500 font-medium text-center">
                    </div>
                    <input type="text" id="input-ref-encomenda" onkeyup="verificarSinal()" placeholder="Ponto de ReferÃªncia (ObrigatÃ³rio)" class="w-full bg-white dark:bg-gray-900 text-gray-800 dark:text-white p-3.5 rounded-xl border border-gray-200 dark:border-gray-700 text-sm outline-none focus:border-orange-500 font-medium">
                </div>

                <div class="bg-gray-50 dark:bg-gray-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-3">Data e Hora da Festa</p>
                    <div class="flex gap-3">
                        <input type="date" id="data-festa" onchange="verificarSinal()" class="bg-white dark:bg-gray-900 text-gray-800 dark:text-white p-3.5 rounded-xl w-full text-sm font-bold border border-gray-200 dark:border-gray-700 outline-none focus:border-orange-500 shadow-sm">
                        <input type="time" id="hora-festa" onchange="verificarSinal()" class="bg-white dark:bg-gray-900 text-gray-800 dark:text-white p-3.5 rounded-xl w-full text-sm font-bold border border-gray-200 dark:border-gray-700 outline-none focus:border-orange-500 shadow-sm">
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-3 flex justify-between items-center">
                        Itens do Pedido 
                        <span id="qtd-itens-resumo" class="bg-gray-100 dark:bg-gray-700 px-2 rounded-full text-gray-500">0</span>
                    </p>
                    <div id="lista-resumo-carrinho" class="space-y-3 mb-4 max-h-40 overflow-y-auto custom-scroll pr-1">
                        </div>
                    
                    <div class="border-t border-dashed border-gray-200 dark:border-gray-700 pt-3 space-y-1">
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>Produtos:</span>
                            <span id="resumo-produtos" class="font-bold">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                            <span>Taxa de Entrega:</span>
                            <span id="resumo-taxa" class="font-bold">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-end mt-2 pt-2 border-t border-gray-100 dark:border-gray-700">
                            <div><p class="text-xs text-gray-400 uppercase font-bold">Total Geral</p><p class="text-xl font-black text-gray-800 dark:text-white" id="resumo-total">R$ 0,00</p></div>
                            <div class="text-right"><p class="text-xs text-orange-500 font-bold uppercase">Sinal MÃ­nimo (50%)</p><p class="text-2xl font-black text-orange-600 dark:text-orange-500" id="resumo-sinal">R$ 0,00</p></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-5 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-xl border border-gray-100 dark:border-gray-700 text-center mb-4">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Chave Pix (Celular)</p>
                        <p class="text-lg font-black text-gray-800 dark:text-white select-all tracking-wider font-mono my-1" id="chave-pix-display">CARREGANDO...</p>
                        <p class="text-[10px] text-gray-500 truncate">Tereza Ceciliana Guaraci Gomes</p>
                        <button onclick="copiarPixEnc()" class="mt-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-orange-600 font-bold px-4 py-1.5 rounded-lg text-xs hover:bg-orange-50 transition shadow-sm">Copiar Chave</button>
                    </div>

                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Valor Pago Agora (Comprovante)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 text-gray-400 font-bold text-sm">R$</span>
                            <input type="number" id="valor-pago-input" onkeyup="verificarSinal()" placeholder="0,00" class="w-full bg-white dark:bg-gray-900 text-gray-800 dark:text-white p-3.5 pl-10 rounded-xl border-2 border-gray-200 dark:border-gray-700 outline-none focus:border-green-500 font-black text-lg transition-colors">
                        </div>
                    </div>

                    <label id="area-upload" class="block w-full border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 text-center cursor-pointer hover:border-orange-500 dark:hover:border-orange-500 hover:bg-orange-50 dark:hover:bg-gray-700/50 transition group relative overflow-hidden">
                        <input type="file" id="foto-comprovante" class="hidden" accept="image/*" onchange="previewFile()">
                        <div id="upload-content">
                            <i class="fas fa-camera text-3xl text-gray-300 dark:text-gray-600 group-hover:text-orange-500 mb-2 transition-colors"></i>
                            <p id="msg-upload" class="text-xs font-bold text-gray-400 group-hover:text-orange-600 dark:group-hover:text-orange-400 transition-colors">Anexar Comprovante do PIX</p>
                        </div>
                        <img id="img-preview-upload" class="hidden absolute inset-0 w-full h-full object-cover opacity-80">
                    </label>
                </div>

                <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-2xl border border-gray-200 dark:border-gray-700">
                    <label class="flex gap-3 items-start cursor-pointer group">
                        <input type="checkbox" id="check-termos" class="mt-1 w-5 h-5 accent-orange-600 rounded border-gray-300 cursor-pointer" onchange="verificarSinal()">
                        <p class="text-[10px] text-gray-500 dark:text-gray-400 leading-relaxed text-justify group-hover:text-gray-700 dark:group-hover:text-gray-300 transition-colors">
                            Concordo com os termos de <strong>Sinal/Arras</strong>. O pagamento de 50% confirma o contrato. Em caso de desistÃªncia em menos de 24h, o sinal serÃ¡ retido.
                        </p>
                    </label>
                </div>
            </div>

            <button id="btn-finalizar-encomenda" onclick="enviarEncomenda()" disabled class="w-full bg-gray-300 dark:bg-gray-800 text-gray-500 py-4 rounded-2xl font-black text-sm fixed bottom-5 left-5 right-5 max-w-[calc(100%-2.5rem)] mx-auto transition flex items-center justify-center gap-2 cursor-not-allowed shadow-none border border-transparent">
                <span id="btn-texto">PREENCHA TUDO PARA CONTINUAR</span>
                <i id="btn-icon" class=""></i>
            </button>
        </div>
    </div>

    <script>
        // --- SEGURANÃ‡A ---
        function escapeHtml(text) {
            if (!text) return text;
            return text.toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const CHAVE_PIX_ENC = "84987371966"; 
        const WHATSAPP_LOJA = "5584987371966"; 
        
        document.getElementById('chave-pix-display').innerText = CHAVE_PIX_ENC;

        // Recupera tema do index.html
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        let carrinho = {}, produtosDb = [], taxasDb = [];
        let tipoEntregaAtual = 'retirada'; 
        
        async function initEncomenda() {
            // 1. Agenda
            const { data: config } = await _supabase.from('store_config').select('schedule_config').single();
            if(config && config.schedule_config) {
                document.getElementById('aviso-agenda').innerHTML = `<i class="fas fa-clock mr-1"></i> HorÃ¡rios: <strong>${escapeHtml(config.schedule_config.horarios_permitidos || 'Consulte')}</strong>`;
            }

            // 2. Produtos
            const { data: prods } = await _supabase.from('products').select('*').eq('is_active', true).eq('for_encomenda', true);
            produtosDb = prods || [];
            
            // 3. Taxas
            const { data: taxas } = await _supabase.from('delivery_fees').select('*').order('neighborhood');
            taxasDb = taxas || [];
            
            const selBairro = document.getElementById('sel-bairro-encomenda');
            taxasDb.forEach(t => {
                selBairro.innerHTML += `<option value="${t.price}">${escapeHtml(t.neighborhood)} (+ R$ ${t.price.toFixed(2)})</option>`;
            });

            // 4. RenderizaÃ§Ã£o
            const container = document.getElementById('lista-produtos');
            if(produtosDb.length === 0) container.innerHTML = '<div class="text-center py-10"><i class="fas fa-calendar-times text-4xl text-gray-300 dark:text-gray-700 mb-2"></i><p class="text-gray-500 text-sm">Nenhum item para encomenda.</p></div>';

            const placeholder = "data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%22%20height%3D%22100%22%20viewBox%3D%220%200%20100%20100%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23f3f4f6%22%2F%3E%3Ctext%20x%3D%2250%22%20y%3D%2250%22%20font-family%3D%22sans-serif%22%20font-size%3D%2214%22%20font-weight%3D%22bold%22%20fill%3D%22%239ca3af%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%3ESem%20Foto%3C%2Ftext%3E%3C%2Fsvg%3E";

            produtosDb.forEach(p => {
                const img = (!p.image_url || p.image_url.length < 10) ? placeholder : p.image_url;
                
                // DETECTA VARIAÃ‡Ã•ES
                let variants = [];
                if (p.variants) {
                    variants = typeof p.variants === 'string' ? JSON.parse(p.variants) : p.variants;
                }
                const hasVariants = Array.isArray(variants) && variants.length > 0;
                const idStr = String(p.id);

                let controlesHtml = '';

                if(hasVariants) {
                    let optionsHtml = '';
                    variants.forEach((v, idx) => {
                        optionsHtml += `<option value="${idx}">${escapeHtml(v.qtd)} un - R$ ${Number(v.price).toFixed(2)}</option>`;
                    });

                    controlesHtml = `
                        <div class="mt-3">
                            <select id="sel-${idStr}" class="w-full bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white text-xs p-2.5 rounded-xl border border-gray-200 dark:border-gray-600 outline-none mb-2 font-bold cursor-pointer">
                                ${optionsHtml}
                            </select>
                            <button onclick="addVariant('${idStr}')" class="w-full bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-3 rounded-xl shadow-sm active:scale-95 transition flex justify-center items-center gap-2">
                                <i class="fas fa-plus"></i> ADICIONAR COMBO
                            </button>
                        </div>
                    `;
                } else {
                    controlesHtml = `
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-orange-600 dark:text-orange-500 font-black text-lg">R$ ${p.price.toFixed(2)}</span>
                            <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-900 rounded-xl p-1 shadow-inner border border-gray-200 dark:border-gray-700">
                                <button onclick="addEnc('${idStr}', -1)" class="w-8 h-8 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-white font-bold transition active:scale-90">-</button>
                                <span id="qtd-${idStr}" class="text-sm font-black w-6 text-center text-gray-800 dark:text-white">0</span>
                                <button onclick="addEnc('${idStr}', 1)" class="w-8 h-8 text-white bg-green-600 rounded-lg hover:bg-green-700 font-bold shadow-sm transition active:scale-90">+</button>
                            </div>
                        </div>
                    `;
                }

                const cardHtml = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-3xl flex gap-4 border border-gray-100 dark:border-gray-700 shadow-sm hover:shadow-md transition">
                    <div class="w-24 h-24 bg-gray-100 dark:bg-gray-700 rounded-2xl overflow-hidden flex-shrink-0 relative group">
                        <img src="${img}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                    </div>
                    <div class="flex-grow flex flex-col justify-between">
                        <div>
                            <h3 class="font-bold text-sm text-gray-800 dark:text-white leading-tight">${escapeHtml(p.name)}</h3>
                            <p class="text-[10px] text-gray-400 line-clamp-2 mt-1">${escapeHtml(p.description || '')}</p>
                        </div>
                        ${controlesHtml}
                    </div>
                </div>`;
                container.innerHTML += cardHtml;
            });
        }

        // --- CARRINHO ---

        function addVariant(prodId) {
            const select = document.getElementById(`sel-${prodId}`);
            if(!select) return;
            const variantIdx = select.value;
            const key = `${prodId}__${variantIdx}`; 
            addEnc(key, 1);
            mostrarToast("Combo adicionado!");
        }

        function addEnc(id, val) {
            const idStr = String(id);
            if(!carrinho[idStr]) carrinho[idStr]=0;
            carrinho[idStr] += val;
            if(carrinho[idStr]<=0) delete carrinho[idStr];
            
            if(!idStr.includes('__')) {
                const el = document.getElementById(`qtd-${idStr}`);
                if(el) el.innerText = carrinho[idStr] || 0;
            }
            
            atualizarBarra();
        }

        function removerItemCarrinho(key) {
            delete carrinho[key];
            if(!key.includes('__')) {
                const el = document.getElementById(`qtd-${key}`);
                if(el) el.innerText = 0;
            }
            atualizarBarra();
            renderizarResumoCarrinho(); 
            verificarSinal(); 
            mostrarToast("Item removido");
        }

        function limparCarrinho() {
            if(Object.keys(carrinho).length === 0) return;
            carrinho = {};
            document.querySelectorAll('[id^="qtd-"]').forEach(el => el.innerText = '0');
            atualizarBarra();
            mostrarToast("Carrinho esvaziado!", "sucesso");
        }

        function atualizarBarra() {
            let total = 0;
            for(const [key, qtd] of Object.entries(carrinho)) {
                const parts = key.split('__');
                const prodId = parts[0];
                const variantIdx = parts[1];

                const p = produtosDb.find(x => String(x.id) === String(prodId));
                if(p) {
                    let variants = p.variants;
                    if(typeof variants === 'string') variants = JSON.parse(variants);

                    let preco = p.price; 
                    if(variantIdx !== undefined && variants && variants[variantIdx]) {
                        preco = Number(variants[variantIdx].price);
                    }
                    total += preco * qtd;
                }
            }
            document.getElementById('total-barra').innerText = `R$ ${total.toFixed(2)}`;
            const bar = document.getElementById('barra-pedido');
            total > 0 ? bar.classList.remove('translate-y-full', 'hidden') : bar.classList.add('translate-y-full');
        }

        // --- CHECKOUT ---

        function abrirCheckoutEncomenda() {
            mudarTipoEntrega('retirada'); 
            document.getElementById('modal-encomenda').classList.remove('hidden');
            renderizarResumoCarrinho();
            verificarSinal();
        }

        function renderizarResumoCarrinho() {
            const lista = document.getElementById('lista-resumo-carrinho');
            lista.innerHTML = '';
            let qtdTotal = 0;

            for(const [key, qtd] of Object.entries(carrinho)) {
                const parts = key.split('__');
                const prodId = parts[0];
                const variantIdx = parts[1];
                const p = produtosDb.find(x => String(x.id) === String(prodId));

                if(p) {
                    let nomeItem = escapeHtml(p.name);
                    let precoUnit = p.price;
                    
                    let variants = p.variants;
                    if(typeof variants === 'string') variants = JSON.parse(variants);

                    if(variantIdx !== undefined && variants && variants[variantIdx]) {
                        nomeItem += ` <strong class="text-orange-500">(${escapeHtml(variants[variantIdx].qtd)} un)</strong>`;
                        precoUnit = Number(variants[variantIdx].price);
                    }

                    const subtotal = precoUnit * qtd;
                    qtdTotal += qtd;

                    lista.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-900 p-2.5 rounded-lg border border-gray-100 dark:border-gray-700">
                            <div>
                                <p class="text-xs font-bold text-gray-800 dark:text-white leading-tight">${qtd}x ${nomeItem}</p>
                                <p class="text-[10px] text-gray-500 dark:text-gray-400">Unit: R$ ${precoUnit.toFixed(2)}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-black text-gray-700 dark:text-gray-300">R$ ${subtotal.toFixed(2)}</span>
                                <button onclick="removerItemCarrinho('${key}')" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    `;
                }
            }
            document.getElementById('qtd-itens-resumo').innerText = qtdTotal;
        }

        function mudarTipoEntrega(tipo) {
            tipoEntregaAtual = tipo;
            const btnRet = document.getElementById('btn-tipo-retirada');
            const btnEnt = document.getElementById('btn-tipo-entrega');
            const boxEnd = document.getElementById('box-endereco-entrega');

            if (tipo === 'retirada') {
                btnRet.className = "flex-1 py-3 rounded-xl text-xs font-bold transition-all bg-white dark:bg-gray-700 text-gray-800 dark:text-white shadow-sm border border-gray-200 dark:border-gray-600";
                btnEnt.className = "flex-1 py-3 rounded-xl text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white";
                boxEnd.classList.add('hidden');
            } else {
                btnEnt.className = "flex-1 py-3 rounded-xl text-xs font-bold transition-all bg-orange-600 text-white border border-orange-500 shadow-md";
                btnRet.className = "flex-1 py-3 rounded-xl text-xs font-bold transition-all text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white";
                boxEnd.classList.remove('hidden');
            }
            verificarSinal();
        }

        function previewFile() {
            const input = document.getElementById('foto-comprovante');
            const img = document.getElementById('img-preview-upload');
            const content = document.getElementById('upload-content');
            
            if(input.files && input.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    content.classList.add('opacity-0');
                    document.getElementById('area-upload').classList.add('border-green-500');
                }
                reader.readAsDataURL(input.files[0]);
            }
            verificarSinal();
        }

        function verificarSinal() {
            let totalProdutos = 0;
            for(const [key, qtd] of Object.entries(carrinho)) {
                const parts = key.split('__');
                const p = produtosDb.find(x => String(x.id) === String(parts[0]));
                if(p) {
                    let variants = p.variants;
                    if(typeof variants === 'string') variants = JSON.parse(variants);
                    let preco = p.price;
                    if(parts[1] !== undefined && variants && variants[parts[1]]) {
                        preco = Number(variants[parts[1]].price);
                    }
                    totalProdutos += preco * qtd;
                }
            }

            let taxaEntrega = 0;
            if (tipoEntregaAtual === 'entrega') {
                const sel = document.getElementById('sel-bairro-encomenda');
                taxaEntrega = parseFloat(sel.value) || 0;
            }

            const totalGeral = totalProdutos + taxaEntrega;
            const minimoSinal = totalGeral / 2;

            const valorPago = parseFloat(document.getElementById('valor-pago-input').value) || 0;
            const termoAceito = document.getElementById('check-termos').checked;
            const data = document.getElementById('data-festa').value;
            const hora = document.getElementById('hora-festa').value;
            const temArquivo = document.getElementById('foto-comprovante').files.length > 0;
            
            // VALIDAÃ‡ÃƒO DETALHADA DE ENDEREÃ‡O
            const rua = document.getElementById('input-rua-encomenda').value.trim();
            const num = document.getElementById('input-numero-encomenda').value.trim();
            const ref = document.getElementById('input-ref-encomenda').value.trim();
            
            document.getElementById('resumo-produtos').innerText = `R$ ${totalProdutos.toFixed(2)}`;
            document.getElementById('resumo-taxa').innerText = `R$ ${taxaEntrega.toFixed(2)}`;
            document.getElementById('resumo-total').innerText = `R$ ${totalGeral.toFixed(2)}`;
            document.getElementById('resumo-sinal').innerText = `R$ ${minimoSinal.toFixed(2)}`;

            const btn = document.getElementById('btn-finalizar-encomenda');
            const btnTexto = document.getElementById('btn-texto');
            
            let msgErro = "";

            if (tipoEntregaAtual === 'entrega' && (taxaEntrega === 0 || !rua || !num || !ref)) msgErro = "PREENCHA ENDEREÃ‡O COMPLETO";
            else if (!data || !hora) msgErro = "ESCOLHA DATA E HORA";
            else if (valorPago < minimoSinal) msgErro = `SINAL MÃNIMO: R$ ${minimoSinal.toFixed(2)}`;
            else if (!temArquivo) msgErro = "ANEXE O COMPROVANTE";
            else if (!termoAceito) msgErro = "ACEITE OS TERMOS";

            if (msgErro) {
                btnTexto.innerText = msgErro;
                btn.classList.add('bg-gray-300', 'dark:bg-gray-800', 'text-gray-500', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-green-600', 'text-white', 'shadow-xl', 'hover:bg-green-700');
                btn.disabled = true;
            } else {
                btnTexto.innerText = "ENVIAR PEDIDO NO WHATSAPP";
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'dark:bg-gray-800', 'text-gray-500', 'cursor-not-allowed', 'shadow-none');
                btn.classList.add('bg-green-600', 'text-white', 'shadow-xl', 'hover:bg-green-700');
            }
        }

        async function enviarEncomenda() {
            const btn = document.getElementById('btn-finalizar-encomenda');
            const btnTexto = document.getElementById('btn-texto');
            const btnIcon = document.getElementById('btn-icon');
            
            btn.disabled = true;
            btnTexto.innerText = "ENVIANDO COMPROVANTE...";
            btnIcon.className = "fas fa-spinner fa-spin";
            
            try {
                // Upload
                const file = document.getElementById('foto-comprovante').files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `comprovante_${Date.now()}.${fileExt}`;
                
                const { error: uploadError } = await _supabase.storage.from('imagens').upload(`comprovantes/${fileName}`, file);
                
                let proofUrl = "Erro no upload";
                if (!uploadError) {
                    const { data: publicData } = _supabase.storage.from('imagens').getPublicUrl(`comprovantes/${fileName}`);
                    proofUrl = publicData.publicUrl;
                }

                // Dados
                const dataFesta = document.getElementById('data-festa').value.split('-').reverse().join('/');
                const hora = document.getElementById('hora-festa').value;
                const valorPago = document.getElementById('valor-pago-input').value;
                const totalGeral = document.getElementById('resumo-total').innerText;
                
                // EndereÃ§o Completo
                const rua = document.getElementById('input-rua-encomenda').value;
                const num = document.getElementById('input-numero-encomenda').value;
                const ref = document.getElementById('input-ref-encomenda').value;
                const enderecoCompleto = `${rua}, NÂº ${num} - Ref: ${ref}`;

                // Monta Mensagem WhatsApp
                let msg = `*NOVA ENCOMENDA AGENDADA* ðŸ“…\n`;
                msg += `-----------------\n`;
                
                if(tipoEntregaAtual === 'entrega') {
                    const sel = document.getElementById('sel-bairro-encomenda');
                    const bairroNome = sel.options[sel.selectedIndex].text.split(' (+')[0];
                    msg += `ðŸ›µ *ENTREGA:* ${dataFesta} Ã s ${hora}\n`;
                    msg += `ðŸ“ *EndereÃ§o:* ${enderecoCompleto}\n*Bairro:* ${bairroNome}\n`;
                } else {
                    msg += `ðŸ¥¡ *RETIRADA:* ${dataFesta} Ã s ${hora}\n`;
                }

                msg += `-----------------\n`;
                for(const [key, qtd] of Object.entries(carrinho)) {
                    const parts = key.split('__');
                    const p = produtosDb.find(x => String(x.id) === String(parts[0]));
                    if(p){
                        let variants = p.variants;
                        if(typeof variants === 'string') variants = JSON.parse(variants);
                        
                        if(parts[1] !== undefined && variants && variants[parts[1]]) {
                            msg += `${qtd}x ${p.name} *(${variants[parts[1]].qtd} un)*\n`;
                        } else {
                            msg += `${qtd}x ${p.name}\n`;
                        }
                    }
                }
                
                msg += `-----------------\n`;
                msg += `ðŸ’° Total Geral: ${totalGeral}\n`;
                msg += `âœ… Sinal Pago: R$ ${valorPago}\n`;
                
                const valTotalNum = parseFloat(totalGeral.replace('R$ ',''));
                const valPagoNum = parseFloat(valorPago);
                msg += `âš ï¸ Restante a Pagar: R$ ${(valTotalNum - valPagoNum).toFixed(2)}\n`;
                
                if(proofUrl !== "Erro no upload") {
                    msg += `\nðŸ“Ž *Comprovante:* ${proofUrl}`;
                } else {
                    msg += `\n(Envio o comprovante na sequÃªncia...)`;
                }

                // Salva no Banco (com escape)
                await _supabase.from('orders').insert([{
                    items: carrinho,
                    total_amount: valTotalNum,
                    payment_method: 'pix_sinal',
                    delivery_type: tipoEntregaAtual,
                    proof_url: proofUrl,
                    address: tipoEntregaAtual === 'entrega' ? enderecoCompleto : 'Retirada',
                    customer_name: 'Encomenda Web'
                }]);

                window.open(`https://wa.me/${WHATSAPP_LOJA}?text=${encodeURIComponent(msg)}`, '_blank');
                
                btnTexto.innerText = "PEDIDO ENVIADO!";
                btnIcon.className = "fas fa-check";
                setTimeout(() => location.reload(), 2000);

            } catch (error) {
                console.error(error);
                alert("Erro ao processar: " + error.message);
                btn.disabled = false;
                btnTexto.innerText = "TENTAR NOVAMENTE";
                btnIcon.className = "";
            }
        }
        
        function copiarPixEnc(){ navigator.clipboard.writeText(CHAVE_PIX_ENC); mostrarToast("Chave copiada!"); }

        initEncomenda();
    </script>
</body>
</html>