<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Alfa Salgateria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 pb-20 select-none font-sans">

    <div id="toast-container" class="fixed top-4 right-4 z-[60] flex flex-col gap-2"></div>

    <header class="bg-orange-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <h1 class="font-bold uppercase text-sm tracking-widest">Painel Alfa</h1>
            
            <div class="flex items-center gap-2 bg-orange-700 px-3 py-1 rounded-full cursor-pointer transition-colors hover:bg-orange-800" onclick="alternarLoja()">
                <div id="status-bolinha" class="w-3 h-3 rounded-full bg-gray-400 shadow-md"></div>
                <span id="status-texto" class="text-[10px] font-bold uppercase">Carregando...</span>
            </div>
            
            <button onclick="sair()" class="text-orange-200 hover:text-white transition-colors"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <nav class="max-w-xl mx-auto mt-4 px-4">
        <div class="flex bg-white rounded-2xl shadow-sm p-1">
            <button onclick="mudarAba('produtos')" id="tab-produtos" class="flex-1 py-2 text-xs font-bold uppercase rounded-xl transition-all bg-orange-100 text-orange-700">Card√°pio</button>
            <button onclick="mudarAba('clientes')" id="tab-clientes" class="flex-1 py-2 text-xs font-bold uppercase rounded-xl transition-all text-gray-400 hover:text-gray-600">Clientes</button>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-4 space-y-6">
        
        <div id="view-produtos" class="space-y-6">
            <section class="bg-white p-6 rounded-3xl shadow-sm border border-orange-50 relative">
                <h2 id="titulo-form" class="text-lg font-black mb-4 text-gray-800 uppercase italic">Novo Item</h2>
                <button id="btn-cancelar" onclick="limparFormulario()" class="hidden absolute top-6 right-6 text-red-500 text-[10px] font-bold uppercase hover:underline">Cancelar</button>

                <div class="space-y-3">
                    <input type="hidden" id="prod-id">
                    <select id="prod-categoria" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500"></select>
                    
                    <input type="text" id="prod-nome" placeholder="Nome do Salgado" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500">
                    
                    <textarea id="prod-desc" rows="2" placeholder="Descri√ß√£o/Ingredientes (Ex: Massa de batata, sem lactose...)" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500 resize-none"></textarea>

                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" step="0.01" id="prod-preco" placeholder="Pre√ßo (R$)" class="p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500">
                        <input type="number" step="0.01" id="prod-preco-promo" placeholder="Promo√ß√£o (R$)" class="p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500">
                    </div>
                    
                    <div class="flex items-center gap-2 px-1">
                        <input type="checkbox" id="prod-em-promo" class="accent-orange-600 w-4 h-4">
                        <label for="prod-em-promo" class="text-xs font-bold text-gray-500 uppercase">Ativar Promo√ß√£o?</label>
                    </div>
                    
                    <input type="file" id="prod-foto" accept="image/*" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-orange-50 file:text-orange-700">
                    
                    <button onclick="salvarProduto()" id="btn-salvar" class="w-full bg-orange-600 text-white font-black py-3 rounded-xl shadow-lg shadow-orange-100 active:scale-95 transition-all hover:bg-orange-700">SALVAR</button>
                </div>
            </section>
            
            <div id="lista-produtos" class="space-y-2 pb-10"></div>
        </div>

        <div id="view-clientes" class="hidden space-y-6">
            <section class="bg-white p-6 rounded-3xl shadow-sm border border-blue-50">
                <h2 class="text-lg font-black mb-4 text-gray-800 uppercase italic">Cadastrar Cliente</h2>
                <div class="space-y-3">
                    <input type="text" id="cli-nome" placeholder="Nome Completo" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-blue-500">
                    <input type="text" id="cli-phone" placeholder="WhatsApp (Somente n√∫meros)" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-blue-500">
                    <input type="text" id="cli-address" placeholder="Endere√ßo Completo" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-blue-500">
                    <button onclick="salvarCliente()" class="w-full bg-blue-600 text-white font-black py-3 rounded-xl shadow-lg shadow-blue-100 active:scale-95 transition-all hover:bg-blue-700">SALVAR CLIENTE</button>
                </div>
            </section>
            <div id="lista-clientes" class="space-y-2 pb-10"></div>
        </div>

    </main>

    <script>
        const SUPABASE_URL = 'https://zpdpscjjxqkbuhesdtyq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3uaoU1fmUEKBrDmbhnk0qw_j3hsPk06';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let produtosCache = [];
        let configId = null;

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) window.location.href = 'login.html';
            await Promise.all([carregarConfigLoja(), carregarCategorias(), carregarProdutos(), carregarClientes()]);
        }

        function mostrarAviso(msg, tipo = 'sucesso') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const cor = tipo === 'erro' ? 'bg-red-500' : 'bg-green-500';
            const icone = tipo === 'erro' ? 'fa-times-circle' : 'fa-check-circle';
            toast.className = `toast ${cor} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 min-w-[250px] z-50`;
            toast.innerHTML = `<i class="fas ${icone}"></i> <span class="text-sm font-bold">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- LOJA ---
        async function carregarConfigLoja() {
            const { data } = await _supabase.from('store_config').select('*').limit(1);
            if (data && data.length > 0) {
                configId = data[0].id;
                atualizarVisualLoja(data[0].is_open);
            }
        }

        function atualizarVisualLoja(estaAberta) {
            const bolinha = document.getElementById('status-bolinha');
            const texto = document.getElementById('status-texto');
            if (estaAberta) {
                bolinha.className = "w-3 h-3 rounded-full bg-green-400 shadow-md";
                texto.innerText = "LOJA ABERTA";
            } else {
                bolinha.className = "w-3 h-3 rounded-full bg-red-500 shadow-md";
                texto.innerText = "FECHADO";
            }
        }

        async function alternarLoja() {
            const textoAtual = document.getElementById('status-texto').innerText;
            const novoEstado = textoAtual === "FECHADO" ? true : false;
            const { error } = await _supabase.from('store_config').update({ is_open: novoEstado }).eq('id', configId);
            if (error) mostrarAviso("Erro ao mudar status", "erro");
            else {
                atualizarVisualLoja(novoEstado);
                mostrarAviso(novoEstado ? "Loja Aberta!" : "Loja Fechada!");
            }
        }

        // --- CLIENTES ---
        async function salvarCliente() {
            const nome = document.getElementById('cli-nome').value;
            const fone = document.getElementById('cli-phone').value;
            const end = document.getElementById('cli-address').value;
            if (!nome || !fone) return mostrarAviso("Preencha Nome e Telefone!", "erro");

            const { error } = await _supabase.from('clients').insert([{ name: nome, phone: fone, address: end }]);
            if (error) mostrarAviso("Erro ao salvar: " + error.message, "erro");
            else {
                mostrarAviso("Cliente cadastrado!");
                document.getElementById('cli-nome').value = '';
                document.getElementById('cli-phone').value = '';
                document.getElementById('cli-address').value = '';
                carregarClientes();
            }
        }

        async function carregarClientes() {
            const { data } = await _supabase.from('clients').select('*').order('created_at', { ascending: false });
            const lista = document.getElementById('lista-clientes');
            lista.innerHTML = '';
            data.forEach(c => {
                lista.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border border-blue-50 flex justify-between items-center hover:shadow-md transition-shadow">
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${c.name}</p>
                            <p class="text-xs text-gray-400">${c.phone}</p>
                        </div>
                        <button onclick="copiarTexto('${c.address}')" class="text-blue-500 text-[10px] font-bold uppercase bg-blue-50 px-2 py-1 rounded-lg"><i class="fas fa-copy"></i> Endere√ßo</button>
                    </div>`;
            });
        }

        function copiarTexto(txt) {
            navigator.clipboard.writeText(txt);
            mostrarAviso("Endere√ßo copiado!");
        }

        // --- PRODUTOS ---
        async function carregarCategorias() {
            const { data } = await _supabase.from('categories').select('*').order('name');
            const select = document.getElementById('prod-categoria');
            select.innerHTML = '<option value="">Selecione...</option>';
            data.forEach(c => select.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }

        async function salvarProduto() {
            const btn = document.getElementById('btn-salvar');
            btn.innerText = "GRAVANDO..."; btn.disabled = true;

            try {
                const nome = document.getElementById('prod-nome').value;
                const desc = document.getElementById('prod-desc').value; // Captura descri√ß√£o
                const cat = document.getElementById('prod-categoria').value;
                const preco = parseFloat(document.getElementById('prod-preco').value.replace(',', '.'));
                const promo = document.getElementById('prod-preco-promo').value ? parseFloat(document.getElementById('prod-preco-promo').value.replace(',', '.')) : null;

                if (!nome || !preco || !cat) throw new Error("Preencha Nome, Pre√ßo e Categoria.");

                // Upload
                const file = document.getElementById('prod-foto').files[0];
                let imgUrl = null;
                if (file) {
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9]/g, '')}`;
                    const { data, error } = await _supabase.storage.from('salgados').upload(fileName, file);
                    if (error) throw error;
                    const { data: publicUrl } = _supabase.storage.from('salgados').getPublicUrl(fileName);
                    imgUrl = publicUrl.publicUrl;
                }

                const payload = { 
                    name: nome, 
                    description: desc, // Salva descri√ß√£o
                    price: preco, 
                    sale_price: promo, 
                    on_sale: document.getElementById('prod-em-promo').checked, 
                    category_id: cat 
                };

                if (imgUrl) payload.image_url = imgUrl;
                else if (!document.getElementById('prod-id').value) payload.image_url = 'https://via.placeholder.com/150';

                const id = document.getElementById('prod-id').value;
                const { error } = id 
                    ? await _supabase.from('products').update(payload).eq('id', id)
                    : await _supabase.from('products').insert([payload]);

                if (error) throw error;

                mostrarAviso("Produto salvo com sucesso!");
                limparFormulario();
                carregarProdutos();

            } catch (erro) {
                mostrarAviso(erro.message, "erro");
                console.error(erro);
            } finally {
                btn.innerText = "SALVAR"; btn.disabled = false;
            }
        }

        async function carregarProdutos() {
            const { data } = await _supabase.from('products').select('*, categories(name)').order('created_at', { ascending: false });
            produtosCache = data;
            const lista = document.getElementById('lista-produtos');
            lista.innerHTML = '';
            
            data.forEach(p => {
                lista.innerHTML += `
                    <div class="bg-white p-3 rounded-2xl border border-gray-100 flex items-center gap-3 hover:shadow-md transition-all">
                        <img src="${p.image_url}" class="w-12 h-12 rounded-lg object-cover bg-gray-50 border border-gray-100">
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-gray-800 text-sm truncate">${p.name} ${p.on_sale ? 'üî•' : ''}</p>
                            <p class="text-xs text-gray-400 truncate">${p.description || 'Sem descri√ß√£o'}</p>
                            <p class="text-orange-600 font-bold text-xs">R$ ${p.on_sale ? p.sale_price : p.price}</p>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="editar('${p.id}')" class="bg-blue-50 text-blue-500 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="deletar('${p.id}')" class="bg-red-50 text-red-500 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    </div>`;
            });
        }

        function editar(id) {
            const p = produtosCache.find(x => x.id === id);
            if (!p) return;
            document.getElementById('prod-id').value = p.id;
            document.getElementById('prod-nome').value = p.name;
            document.getElementById('prod-desc').value = p.description || ''; // Carrega descri√ß√£o
            document.getElementById('prod-categoria').value = p.category_id;
            document.getElementById('prod-preco').value = p.price;
            document.getElementById('prod-preco-promo').value = p.sale_price || '';
            document.getElementById('prod-em-promo').checked = p.on_sale;
            
            document.getElementById('btn-salvar').innerText = "ATUALIZAR";
            document.getElementById('btn-salvar').classList.replace('bg-orange-600', 'bg-blue-600');
            document.getElementById('titulo-form').innerText = "Editando Item";
            document.getElementById('btn-cancelar').classList.remove('hidden');
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function limparFormulario() {
            document.getElementById('prod-id').value = '';
            document.getElementById('prod-nome').value = '';
            document.getElementById('prod-desc').value = '';
            document.getElementById('prod-preco').value = '';
            document.getElementById('prod-preco-promo').value = '';
            document.getElementById('prod-foto').value = '';
            document.getElementById('prod-em-promo').checked = false;
            
            document.getElementById('btn-salvar').innerText = "SALVAR";
            document.getElementById('btn-salvar').classList.replace('bg-blue-600', 'bg-orange-600');
            document.getElementById('titulo-form').innerText = "Novo Item";
            document.getElementById('btn-cancelar').classList.add('hidden');
        }

        async function deletar(id) {
            if (confirm("Tem certeza?")) {
                await _supabase.from('products').delete().eq('id', id);
                carregarProdutos();
                mostrarAviso("Item removido.");
            }
        }

        function mudarAba(aba) {
            document.getElementById('view-produtos').classList.add('hidden');
            document.getElementById('view-clientes').classList.add('hidden');
            document.getElementById('tab-produtos').className = "flex-1 py-2 text-xs font-bold uppercase rounded-xl transition-all text-gray-400";
            document.getElementById('tab-clientes').className = "flex-1 py-2 text-xs font-bold uppercase rounded-xl transition-all text-gray-400";
            
            document.getElementById('view-' + aba).classList.remove('hidden');
            document.getElementById('tab-' + aba).className = "flex-1 py-2 text-xs font-bold uppercase rounded-xl transition-all bg-orange-100 text-orange-700 shadow-sm";
        }

        async function sair() {
            await _supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        init();
    </script>
</body>
</html>