<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="global.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100 pb-32 select-none">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-50 dark:bg-gray-900 z-[200] flex items-center justify-center">
        <div class="flex flex-col items-center gap-4">
            <i class="fas fa-circle-notch fa-spin text-4xl text-orange-600"></i>
            <p class="text-sm font-bold text-gray-400 uppercase tracking-widest">Carregando Painel...</p>
        </div>
    </div>

    <header class="bg-orange-600 dark:bg-gray-900 text-white p-6 pb-8 rounded-b-[2rem] shadow-lg sticky top-0 z-50">
        <div class="max-w-xl mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <a href="index.html" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i class="fas fa-arrow-left text-xs"></i></a>
                    <h1 class="font-black text-lg tracking-wide uppercase">Painel Alfa</h1>
                </div>
                <div class="flex gap-2">
                    <button onclick="alternarTema()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i id="icone-tema" class="fas fa-moon text-xs"></i></button>
                    <button onclick="sair()" class="w-8 h-8 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i class="fas fa-sign-out-alt text-xs"></i></button>
                </div>
            </div>
            
            <div class="bg-white/10 p-3 rounded-xl flex items-center gap-3">
                <i class="fas fa-clock text-orange-200"></i>
                <input type="text" id="tempo-entrega" placeholder="Tempo (Ex: 40min)" class="bg-transparent border-b border-orange-300/50 text-white placeholder-orange-200/50 outline-none text-sm font-bold flex-grow">
                <button onclick="salvarTempo()" class="text-xs bg-white text-orange-600 font-bold px-3 py-1 rounded-lg">SALVAR</button>
            </div>
        </div>
    </header>

    <nav class="max-w-xl mx-auto -mt-6 px-4 relative z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft p-1.5 flex gap-1 overflow-x-auto">
            <button onclick="mudarAba('produtos')" id="tab-produtos" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Cardápio</button>
            <button onclick="mudarAba('taxas')" id="tab-taxas" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Taxas</button>
            <button onclick="mudarAba('cupons')" id="tab-cupons" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Cupons</button>
            <button onclick="mudarAba('categorias')" id="tab-categorias" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Categs</button>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-4 space-y-6 min-h-[50vh]">
        
        <div id="view-produtos" class="hidden space-y-6">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-soft border border-orange-50 dark:border-gray-700">
                <div class="flex justify-between mb-4"><h2 class="font-black text-orange-600">Novo Item</h2><button onclick="limparForm()" class="hidden text-xs text-red-500 font-bold" id="btn-cancelar">X</button></div>
                <div class="space-y-3">
                    <input type="hidden" id="prod-id">
                    <select id="prod-categoria" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white"></select>
                    <input type="text" id="prod-nome" placeholder="Nome" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white">
                    <textarea id="prod-desc" rows="2" placeholder="Descrição" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white"></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="prod-preco" placeholder="Preço" class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white">
                        <input type="number" id="prod-preco-promo" placeholder="Promo" class="p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border-0 outline-none">
                    </div>
                    <label class="flex items-center gap-2 text-xs font-bold text-gray-500"><input type="checkbox" id="prod-em-promo" class="accent-orange-600"> Oferta?</label>
                    <input type="file" id="prod-foto" accept="image/*" class="w-full text-xs text-gray-400">
                    <button onclick="salvarProduto()" id="btn-salvar" class="w-full bg-orange-600 text-white font-black py-3 rounded-xl shadow-lg">SALVAR</button>
                </div>
            </section>
            <div id="lista-produtos-organizada" class="space-y-4"></div>
        </div>

        <div id="view-taxas" class="hidden space-y-6">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-soft border-l-4 border-blue-500">
                <h2 class="font-black mb-4 text-blue-600">Taxas</h2>
                <div class="flex gap-2"><input type="text" id="taxa-bairro" placeholder="Bairro" class="flex-grow p-3 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white"><input type="number" id="taxa-valor" placeholder="R$" class="w-20 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white"></div>
                <button onclick="salvarTaxa()" class="w-full mt-3 bg-blue-600 text-white font-bold py-3 rounded-xl">ADICIONAR</button>
            </section>
            <div id="lista-taxas" class="space-y-2"></div>
        </div>

        <div id="view-cupons" class="hidden space-y-6">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-soft border-l-4 border-green-500">
                <h2 class="font-black mb-4 text-green-600">Cupons</h2>
                <div class="space-y-2">
                    <div class="flex gap-2">
                        <input type="text" id="cupom-codigo" placeholder="Código" class="flex-grow p-3 rounded-xl bg-gray-50 dark:bg-gray-700 uppercase dark:text-white">
                        <input type="number" id="cupom-porc" placeholder="%" class="w-20 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div><label>Início</label><input type="datetime-local" id="cupom-inicio" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded dark:text-white"></div>
                        <div><label>Fim</label><input type="datetime-local" id="cupom-fim" class="w-full p-2 bg-gray-50 dark:bg-gray-700 rounded dark:text-white"></div>
                    </div>
                    <button onclick="salvarCupom()" class="w-full mt-3 bg-green-600 text-white font-bold py-3 rounded-xl">CRIAR</button>
                </div>
            </section>
            <div id="lista-cupons" class="space-y-2"></div>
        </div>

        <div id="view-categorias" class="hidden space-y-6">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-soft border-l-4 border-purple-500">
                <input type="hidden" id="cat-id">
                <input type="text" id="cat-nome" placeholder="Nome Categoria" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white mb-2">
                <button onclick="salvarCategoria()" id="btn-salvar-cat" class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl">SALVAR</button>
            </section>
            <div id="lista-categorias-admin" class="space-y-2"></div>
        </div>
    </main>

    <script>
        let produtos=[], categorias=[], configId=null;

        async function init() {
            try {
                const {data:{session}} = await _supabase.auth.getSession();
                if(!session) { window.location.href='login.html'; return; }
                
                await Promise.all([carregarConfig(), carregarDados()]);
                
            } catch(e) {
                console.error("Erro init:", e);
                // Mesmo com erro, tenta mostrar o que deu
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
                mudarAba('produtos');
            }
        }

        async function carregarDados() {
            try {
                const [cats, prods, tx, cp] = await Promise.all([
                    _supabase.from('categories').select('*').order('name'),
                    _supabase.from('products').select('*').order('created_at',{ascending:false}),
                    _supabase.from('delivery_fees').select('*'),
                    _supabase.from('coupons').select('*').order('created_at',{ascending:false})
                ]);
                categorias=cats.data||[]; produtos=prods.data||[];
                
                renderizarProdutos(categorias, produtos);
                renderizarListas(tx.data||[], 'lista-taxas', 'delivery_fees');
                renderizarCupons(cp.data||[]);
                
                const s=document.getElementById('prod-categoria'); s.innerHTML='<option value="">Categoria...</option>';
                categorias.forEach(c=>s.innerHTML+=`<option value="${c.id}">${c.name}</option>`);
            } catch(e) {
                console.error(e);
            }
        }

        function mudarAba(aba){
            ['produtos','taxas','cupons','categorias'].forEach(x=>{
                document.getElementById('view-'+x).classList.add('hidden');
                document.getElementById('tab-'+x).className="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2 text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition";
            });
            document.getElementById('view-'+aba).classList.remove('hidden');
            document.getElementById('tab-'+aba).className=`flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2 bg-orange-100 text-orange-600 shadow-sm`;
        }

        function renderizarProdutos(cats, prods) {
            const c=document.getElementById('lista-produtos-organizada'); c.innerHTML='';
            cats.forEach(cat => {
                const itens = prods.filter(p=>p.category_id===cat.id);
                let h=`<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft overflow-hidden mb-4"><div onclick="toggleAcc('${cat.id}')" class="p-4 flex justify-between cursor-pointer bg-gray-50 dark:bg-gray-700/50"><h3 class="font-bold text-gray-700 dark:text-white uppercase text-sm flex items-center gap-2"><span class="bg-orange-100 text-orange-600 w-6 h-6 flex items-center justify-center rounded-lg text-xs">${itens.length}</span> ${cat.name}</h3><i id="seta-${cat.id}" class="fas fa-chevron-down text-gray-400"></i></div><div id="lista-${cat.id}" class="hidden p-2 space-y-2">`;
                itens.forEach(p=>{h+=`<div class="flex items-center gap-3 p-2 bg-gray-50 dark:bg-gray-900/50 rounded-xl"><div class="flex-grow min-w-0"><p class="font-bold text-xs dark:text-white truncate">${p.name}</p><p class="text-[10px] text-orange-600 font-black">R$ ${p.price}</p></div><button onclick="editarProduto('${p.id}')" class="text-blue-500 w-8 h-8 rounded flex items-center justify-center bg-blue-50 dark:bg-blue-900/20"><i class="fas fa-pen text-[10px]"></i></button><button onclick="deletarItem('products','${p.id}')" class="text-red-500 w-8 h-8 rounded flex items-center justify-center bg-red-50 dark:bg-red-900/20"><i class="fas fa-trash text-[10px]"></i></button></div>`;});
                h+=`</div></div>`; c.innerHTML+=h;
            });
        }
        function toggleAcc(id){document.getElementById(`lista-${id}`).classList.toggle('hidden');}

        function renderizarListas(lista, elId, tabela) {
            const l=document.getElementById(elId); l.innerHTML='';
            lista.forEach(i => {
                const txt = i.neighborhood || i.name; const val = i.price ? `R$ ${i.price}` : '';
                l.innerHTML += `<div class="bg-white dark:bg-gray-800 p-3 rounded-xl flex justify-between shadow-sm items-center"><span class="dark:text-white font-bold text-sm">${txt} <span class="text-blue-500 ml-2">${val}</span></span><div class="flex gap-2"><button onclick="deletarItem('${tabela}','${i.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }

        function renderizarCupons(lista) {
            const l=document.getElementById('lista-cupons'); l.innerHTML='';
            lista.forEach(c => {
                const isValid = (!c.valid_until || new Date(c.valid_until) > new Date());
                const color = isValid ? 'text-green-600' : 'text-red-400 line-through';
                l.innerHTML += `<div class="bg-white dark:bg-gray-800 p-3 rounded-xl flex justify-between shadow-sm items-center"><div class="${color} font-black text-sm">${c.code} (${c.discount_percent}%)</div><button onclick="deletarItem('coupons','${c.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div>`;
            });
        }

        async function salvarProduto(){
            const nome=document.getElementById('prod-nome').value, cat=document.getElementById('prod-categoria').value, pr=document.getElementById('prod-preco').value;
            if(!nome||!pr||!cat) return mostrarToast("Preencha tudo","erro");
            const btn=document.getElementById('btn-salvar'); btn.innerText="..."; btn.disabled=true;
            const file=document.getElementById('prod-foto').files[0]; let url=null;
            if(file){const n=`${Date.now()}_${file.name.replace(/\W/g,'')}`; const{data}=await _supabase.storage.from('salgados').upload(n,file); if(data){const{data:pub}=_supabase.storage.from('salgados').getPublicUrl(n); url=pub.publicUrl;}}
            const pay={name:nome, description:document.getElementById('prod-desc').value, price:parseFloat(pr), sale_price:document.getElementById('prod-preco-promo').value||null, on_sale:document.getElementById('prod-em-promo').checked, category_id:cat};
            if(url) pay.image_url=url; else if(!document.getElementById('prod-id').value) pay.image_url='https://via.placeholder.com/150';
            const id=document.getElementById('prod-id').value;
            const{error}=id?await _supabase.from('products').update(pay).eq('id',id):await _supabase.from('products').insert([pay]);
            if(!error){mostrarToast("Salvo!"); limparFormulario(); carregarDados();} else mostrarToast("Erro","erro");
            btn.innerText="SALVAR"; btn.disabled=false;
        }

        async function salvarTaxa(){const n=document.getElementById('taxa-bairro').value, v=document.getElementById('taxa-valor').value; if(n&&v){await _supabase.from('delivery_fees').insert([{neighborhood:n,price:v}]); mostrarToast("Salvo!"); carregarDados();}}
        async function salvarCategoria(){const n=document.getElementById('cat-nome').value; if(n){await _supabase.from('categories').insert([{name:n}]); mostrarToast("Salvo!"); carregarDados();}}
        async function salvarCupom(){
            const c=document.getElementById('cupom-codigo').value.toUpperCase(), p=document.getElementById('cupom-porc').value, i=document.getElementById('cupom-inicio').value, f=document.getElementById('cupom-fim').value; if(c&&p){await _supabase.from('coupons').insert([{code:c,discount_percent:p, valid_from:i||null, valid_until:f||null}]); mostrarToast("Criado!"); carregarDados();}
        }
        async function deletarItem(tab,id){abrirModalConfirmacao("Apagar?",async()=>{await _supabase.from(tab).delete().eq('id',id); carregarDados();});}
        function editarProduto(id){const p=produtos.find(x=>x.id==id); document.getElementById('prod-id').value=p.id; document.getElementById('prod-nome').value=p.name; document.getElementById('prod-desc').value=p.description||''; document.getElementById('prod-preco').value=p.price; document.getElementById('prod-categoria').value=p.category_id; document.getElementById('prod-preco-promo').value=p.sale_price||''; document.getElementById('prod-em-promo').checked=p.on_sale; document.getElementById('btn-salvar').innerText="ATUALIZAR"; document.getElementById('btn-cancelar').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'});}
        function limparFormulario(){document.getElementById('prod-id').value=''; document.getElementById('prod-nome').value=''; document.getElementById('prod-desc').value=''; document.getElementById('prod-preco').value=''; document.getElementById('prod-preco-promo').value=''; document.getElementById('prod-foto').value=''; document.getElementById('prod-em-promo').checked=false; document.getElementById('btn-salvar').innerText="SALVAR"; document.getElementById('btn-cancelar').classList.add('hidden');}
        
        async function carregarConfig(){const{data}=await _supabase.from('store_config').select('*').limit(1);if(data && data.length){configId=data[0].id;attLoja(data[0].is_open);document.getElementById('tempo-entrega').value=data[0].delivery_estimate||'';}}
        function attLoja(aberta){document.getElementById('status-bolinha').className=`w-2.5 h-2.5 rounded-full ${aberta?'bg-green-400':'bg-red-500'}`; document.getElementById('status-texto').innerText=aberta?"ABERTO":"FECHADO";}
        async function alternarLoja(){const n=document.getElementById('status-texto').innerText==="FECHADO"; await _supabase.from('store_config').update({is_open:n}).eq('id',configId); attLoja(n); mostrarToast(n?"Loja Aberta":"Loja Fechada");}
        async function salvarTempo(){const t=document.getElementById('tempo-entrega').value; await _supabase.from('store_config').update({delivery_estimate:t}).eq('id',configId); mostrarToast("Tempo Salvo!");}
        async function sair(){await _supabase.auth.signOut();window.location.href='login.html';}
        
        init();
    </script>
</body>
</html>