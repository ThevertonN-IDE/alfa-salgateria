<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="global.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-800 dark:text-gray-100 pb-24 select-none transition-colors duration-300">

    <header class="bg-orange-600 dark:bg-gray-900 text-white p-6 pb-8 rounded-b-[2rem] shadow-lg sticky top-0 z-50">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <h1 class="font-black text-lg tracking-wide uppercase">Painel Alfa</h1>
            <div class="flex gap-3 items-center">
                <div onclick="alternarLoja()" class="flex items-center gap-2 bg-black/20 backdrop-blur-md px-3 py-1.5 rounded-full cursor-pointer border border-white/10"><div id="status-bolinha" class="w-2.5 h-2.5 rounded-full bg-gray-400"></div><span id="status-texto" class="text-[10px] font-bold uppercase">...</span></div>
                <button onclick="alternarTema()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i id="icone-tema" class="fas fa-moon"></i></button>
                <button onclick="sair()" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </header>

    <nav class="max-w-xl mx-auto -mt-6 px-4 relative z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft p-1.5 flex gap-1 overflow-x-auto transition-colors">
            <button onclick="mudarAba('produtos')" id="tab-produtos" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Cardápio</button>
            <button onclick="mudarAba('taxas')" id="tab-taxas" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Taxas</button>
            <button onclick="mudarAba('cupons')" id="tab-cupons" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Cupons</button>
            <button onclick="mudarAba('clientes')" id="tab-clientes" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2">Clientes</button>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-4 space-y-6">
        
        <div id="view-produtos" class="space-y-6 animate-fade">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-soft border border-orange-50 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4"><h2 class="font-black text-orange-600 dark:text-orange-500">NOVO ITEM</h2><button onclick="limparFormulario()" class="hidden text-xs text-red-500 font-bold" id="btn-cancelar">CANCELAR</button></div>
                <div class="space-y-3">
                    <input type="hidden" id="prod-id">
                    <select id="prod-categoria" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white"></select>
                    <input type="text" id="prod-nome" placeholder="Nome" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="prod-preco" placeholder="Preço" class="p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white">
                        <input type="number" id="prod-preco-promo" placeholder="Promo" class="p-3 rounded-xl bg-red-50 dark:bg-red-900/20 border-0 outline-none">
                    </div>
                    <label class="flex items-center gap-2 text-xs font-bold text-gray-500 dark:text-gray-400"><input type="checkbox" id="prod-em-promo" class="accent-orange-600"> Oferta?</label>
                    <input type="file" id="prod-foto" accept="image/*" class="w-full text-xs text-gray-400">
                    <button onclick="salvarProduto()" id="btn-salvar" class="w-full bg-orange-600 text-white font-black py-3 rounded-xl shadow-lg active:scale-95 transition">SALVAR</button>
                </div>
            </section>
            <div id="lista-produtos-organizada" class="space-y-4"></div>
        </div>

        <div id="view-taxas" class="hidden space-y-6 animate-fade">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-soft border-l-4 border-blue-500">
                <h2 class="font-black mb-4 text-blue-600">Taxas</h2>
                <div class="flex gap-2">
                    <input type="text" id="taxa-bairro" placeholder="Bairro" class="flex-grow p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white">
                    <input type="number" id="taxa-valor" placeholder="R$" class="w-20 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white">
                </div>
                <button onclick="salvarTaxa()" id="btn-salvar-taxa" class="w-full mt-3 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">ADICIONAR</button>
            </section>
            <div id="lista-taxas" class="space-y-2"></div>
        </div>

        <div id="view-cupons" class="hidden space-y-6 animate-fade">
            <section class="bg-white dark:bg-gray-800 p-6 rounded-[2rem] shadow-soft border-l-4 border-green-500">
                <h2 class="font-black mb-4 text-green-600">Cupons</h2>
                <div class="flex gap-2">
                    <input type="text" id="cupom-codigo" placeholder="Código" class="flex-grow p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none uppercase dark:text-white">
                    <input type="number" id="cupom-porc" placeholder="%" class="w-20 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border-0 outline-none dark:text-white">
                </div>
                <button onclick="salvarCupom()" id="btn-salvar-cupom" class="w-full mt-3 bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg">CRIAR</button>
            </section>
            <div id="lista-cupons" class="space-y-2"></div>
        </div>

        <div id="view-clientes" class="hidden space-y-4 animate-fade"><div id="lista-clientes"></div></div>
    </main>

    <script>
        // Logica simplificada pois global.js cuida do pesado
        let produtos=[], categorias=[], configId=null;

        async function init() {
            const {data:{session}}=await _supabase.auth.getSession(); if(!session) window.location.href='login.html';
            await Promise.all([carregarConfig(), carregarDados()]);
            mudarAba('produtos');
        }

        async function carregarDados() {
            const [cats, prods] = await Promise.all([_supabase.from('categories').select('*').order('name'), _supabase.from('products').select('*').order('created_at',{ascending:false})]);
            categorias=cats.data||[]; produtos=prods.data||[];
            renderizarProdutos();
        }

        function renderizarProdutos() {
            const c=document.getElementById('lista-produtos-organizada'); c.innerHTML='';
            categorias.forEach(cat => {
                const itens = produtos.filter(p=>p.category_id===cat.id);
                let h=`<div class="bg-white dark:bg-gray-800 rounded-2xl shadow-soft overflow-hidden"><div onclick="toggleAcc('${cat.id}')" class="p-4 flex justify-between cursor-pointer bg-gray-50 dark:bg-gray-700/50"><h3 class="font-bold text-gray-700 dark:text-white uppercase text-sm flex items-center gap-2"><span class="bg-orange-100 text-orange-600 w-6 h-6 flex items-center justify-center rounded-lg text-xs">${itens.length}</span> ${cat.name}</h3><i id="seta-${cat.id}" class="fas fa-chevron-down text-gray-400"></i></div><div id="lista-${cat.id}" class="hidden p-2 space-y-2">`;
                itens.forEach(p=>{h+=`<div class="flex items-center gap-3 p-2 bg-gray-50 dark:bg-gray-900/50 rounded-xl"><img src="${p.image_url}" class="w-10 h-10 rounded-lg bg-gray-200 object-cover"><div class="flex-grow min-w-0"><p class="font-bold text-xs dark:text-white truncate">${p.name}</p><p class="text-[10px] text-orange-600 font-black">R$ ${p.price}</p></div><button onclick="editarProduto('${p.id}')" class="text-blue-500 bg-blue-50 w-7 h-7 rounded flex items-center justify-center"><i class="fas fa-pen text-[10px]"></i></button><button onclick="delGenerico('products','${p.id}')" class="text-red-500 bg-red-50 w-7 h-7 rounded flex items-center justify-center"><i class="fas fa-trash text-[10px]"></i></button></div>`;});
                h+=`</div></div>`; c.innerHTML+=h;
            });
        }
        function toggleAcc(id){ document.getElementById(`lista-${id}`).classList.toggle('hidden'); }

        async function salvarProduto(){
            if(!checkOnline())return;
            const btn=document.getElementById('btn-salvar'); btn.innerText="..."; btn.disabled=true;
            const nome=document.getElementById('prod-nome').value, cat=document.getElementById('prod-categoria').value, pr=document.getElementById('prod-preco').value;
            if(!nome||!pr||!cat) { mostrarToast("Preencha tudo","erro"); btn.innerText="SALVAR"; btn.disabled=false; return; }
            
            const file=document.getElementById('prod-foto').files[0]; let url=null;
            if(file){const n=`${Date.now()}_${file.name.replace(/\W/g,'')}`; const{data}=await _supabase.storage.from('salgados').upload(n,file); const{data:pub}=_supabase.storage.from('salgados').getPublicUrl(n); url=pub.publicUrl;}
            
            const pay={name:nome, description:document.getElementById('prod-desc').value, price:pr, sale_price:document.getElementById('prod-preco-promo').value||null, on_sale:document.getElementById('prod-em-promo').checked, category_id:cat};
            if(url) pay.image_url=url; else if(!document.getElementById('prod-id').value) pay.image_url='https://via.placeholder.com/150';
            
            const id=document.getElementById('prod-id').value;
            const{error}=id?await _supabase.from('products').update(pay).eq('id',id):await _supabase.from('products').insert([pay]);
            
            if(!error){mostrarToast("Salvo!"); limparFormulario(); carregarDados();} else mostrarToast("Erro","erro");
            btn.innerText="SALVAR"; btn.disabled=false;
        }

        function editarProduto(id){const p=produtos.find(x=>x.id==id); document.getElementById('prod-id').value=p.id; document.getElementById('prod-nome').value=p.name; document.getElementById('prod-preco').value=p.price; document.getElementById('prod-categoria').value=p.category_id; document.getElementById('btn-salvar').innerText="ATUALIZAR"; document.getElementById('btn-cancelar').classList.remove('hidden'); window.scrollTo({top:0,behavior:'smooth'});}
        function limparFormulario(){document.getElementById('prod-id').value=''; document.getElementById('prod-nome').value=''; document.getElementById('prod-preco').value=''; document.getElementById('btn-salvar').innerText="SALVAR"; document.getElementById('btn-cancelar').classList.add('hidden');}

        // --- TAXAS/CUPONS ---
        async function carregarConfig(){const{data}=await _supabase.from('store_config').select('*').limit(1);if(data.length){configId=data[0].id;attLoja(data[0].is_open);}}
        function attLoja(aberta){document.getElementById('status-bolinha').className=`w-2.5 h-2.5 rounded-full ${aberta?'bg-green-400':'bg-red-500'}`; document.getElementById('status-texto').innerText=aberta?"ABERTO":"FECHADO";}
        async function alternarLoja(){if(!checkOnline())return; const n=document.getElementById('status-texto').innerText==="FECHADO"; await _supabase.from('store_config').update({is_open:n}).eq('id',configId); attLoja(n); mostrarToast(n?"Loja Aberta":"Loja Fechada");}
        
        async function delGenerico(tab,id){abrirModalConfirmacao("Apagar item?",async()=>{await _supabase.from(tab).delete().eq('id',id); mostrarToast("Apagado!"); if(tab=='products')carregarDados(); if(tab=='delivery_fees')carregarTaxas(); if(tab=='coupons')carregarCupons();});}
        
        function mudarAba(aba){
            ['produtos','taxas','cupons','clientes'].forEach(x=>{document.getElementById('view-'+x).classList.add('hidden'); document.getElementById('tab-'+x).className="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl whitespace-nowrap px-2 text-gray-400";});
            document.getElementById('view-'+aba).classList.remove('hidden');
            document.getElementById('tab-'+aba).classList.add('bg-orange-100','text-orange-600');
            if(aba=='taxas')carregarTaxas(); if(aba=='cupons')carregarCupons(); if(aba=='clientes')carregarClientes();
        }
        
        // (Outras funções de carregar taxas/cupons simplificadas para não estourar limite, seguem mesmo padrão do global.js)
        async function carregarTaxas(){const{data}=await _supabase.from('delivery_fees').select('*'); const l=document.getElementById('lista-taxas');l.innerHTML='';data.forEach(t=>{l.innerHTML+=`<div class="bg-white dark:bg-gray-800 p-3 rounded-xl flex justify-between shadow-sm"><span class="font-bold dark:text-white">${t.neighborhood}</span><div class="flex gap-3"><span class="text-blue-500 font-bold">R$ ${t.price}</span><button onclick="delGenerico('delivery_fees','${t.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`});}
        async function salvarTaxa(){const n=document.getElementById('taxa-bairro').value,v=document.getElementById('taxa-valor').value; if(n&&v){await _supabase.from('delivery_fees').insert([{neighborhood:n,price:v}]); mostrarToast("Salvo!"); carregarTaxas();}}
        
        async function carregarCupons(){const{data}=await _supabase.from('coupons').select('*'); const l=document.getElementById('lista-cupons');l.innerHTML='';data.forEach(c=>{l.innerHTML+=`<div class="bg-white dark:bg-gray-800 p-3 rounded-xl flex justify-between shadow-sm"><span class="font-black text-green-600">${c.code}</span><div class="flex gap-3"><span class="dark:text-white font-bold">${c.discount_percent}%</span><button onclick="delGenerico('coupons','${c.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`});}
        async function salvarCupom(){const c=document.getElementById('cupom-codigo').value.toUpperCase(),p=document.getElementById('cupom-porc').value; if(c&&p){await _supabase.from('coupons').insert([{code:c,discount_percent:p}]); mostrarToast("Criado!"); carregarCupons();}}

        async function carregarClientes(){const{data}=await _supabase.from('clients').select('*').order('created_at',{ascending:false}); const l=document.getElementById('lista-clientes'); l.innerHTML=''; data.forEach(c=>{l.innerHTML+=`<div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-soft mb-2"><div class="flex justify-between"><span class="font-bold dark:text-white text-sm">${c.name}</span><a href="https://wa.me/55${c.phone?c.phone.replace(/\D/g,''):''}" target="_blank" class="text-green-500"><i class="fab fa-whatsapp"></i></a></div><p class="text-xs text-gray-500">${c.address||'-'}</p></div>`;});}

        async function sair(){await _supabase.auth.signOut();window.location.href='login.html';}
        init();
    </script>
</body>
</html>