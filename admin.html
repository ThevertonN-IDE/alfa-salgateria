<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Alfa Salgateria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 pb-20 select-none font-sans">

    <div id="toast-container" class="fixed top-4 right-4 z-[60] flex flex-col gap-2"></div>

    <div id="modal-confirm" class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 max-w-sm w-full shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-4">
                <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <h3 class="text-lg font-black text-gray-800 uppercase">Tem certeza?</h3>
                <p id="modal-msg" class="text-sm text-gray-500 mt-1">Essa ação não pode ser desfeita.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="fecharModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition">CANCELAR</button>
                <button id="btn-confirmar-modal" class="flex-1 py-3 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 transition shadow-lg shadow-red-200">SIM, APAGAR</button>
            </div>
        </div>
    </div>

    <header class="bg-orange-600 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <h1 class="font-bold uppercase text-sm tracking-widest">Painel Alfa</h1>
            <div class="flex items-center gap-2 bg-orange-700 px-3 py-1 rounded-full cursor-pointer transition-colors hover:bg-orange-800" onclick="alternarLoja()">
                <div id="status-bolinha" class="w-3 h-3 rounded-full bg-gray-400 shadow-md"></div>
                <span id="status-texto" class="text-[10px] font-bold uppercase">...</span>
            </div>
            <button onclick="sair()" class="text-orange-200 hover:text-white transition-colors"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <nav class="max-w-xl mx-auto mt-4 px-4">
        <div class="flex bg-white rounded-2xl shadow-sm p-1 gap-1">
            <button onclick="mudarAba('produtos')" id="tab-produtos" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl transition-all bg-orange-100 text-orange-700">Cardápio</button>
            <button onclick="mudarAba('categorias')" id="tab-categorias" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl transition-all text-gray-400 hover:text-gray-600">Categorias</button>
            <button onclick="mudarAba('clientes')" id="tab-clientes" class="flex-1 py-2 text-[10px] font-bold uppercase rounded-xl transition-all text-gray-400 hover:text-gray-600">Usuários</button>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-4 space-y-6">
        <div id="view-produtos" class="space-y-6">
            <section class="bg-white p-6 rounded-3xl shadow-sm border border-orange-50 relative">
                <h2 id="titulo-form" class="text-lg font-black mb-4 text-gray-800 uppercase italic">Novo Item</h2>
                <button id="btn-cancelar" onclick="limparFormulario()" class="hidden absolute top-6 right-6 text-red-500 text-[10px] font-bold uppercase hover:underline">Cancelar</button>

                <div class="space-y-3">
                    <input type="hidden" id="prod-id">
                    <select id="prod-categoria" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500"></select>
                    <input type="text" id="prod-nome" placeholder="Nome do Salgado" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500">
                    <textarea id="prod-desc" rows="2" placeholder="Descrição/Ingredientes..." class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500 resize-none"></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" step="0.01" id="prod-preco" placeholder="Preço (R$)" class="p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500">
                        <input type="number" step="0.01" id="prod-preco-promo" placeholder="Promoção (R$)" class="p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-orange-500">
                    </div>
                    <div class="flex items-center gap-2 px-1">
                        <input type="checkbox" id="prod-em-promo" class="accent-orange-600 w-4 h-4">
                        <label for="prod-em-promo" class="text-xs font-bold text-gray-500 uppercase">Ativar Promoção?</label>
                    </div>
                    <input type="file" id="prod-foto" accept="image/*" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-orange-50 file:text-orange-700">
                    <button onclick="salvarProduto()" id="btn-salvar" class="w-full bg-orange-600 text-white font-black py-3 rounded-xl shadow-lg shadow-orange-100 active:scale-95 transition-all hover:bg-orange-700">SALVAR</button>
                </div>
            </section>
            <div id="lista-produtos" class="space-y-2 pb-10"></div>
        </div>

        <div id="view-categorias" class="hidden space-y-6">
            <section class="bg-white p-6 rounded-3xl shadow-sm border border-purple-50 relative">
                <h2 id="titulo-cat" class="text-lg font-black mb-4 text-gray-800 uppercase italic">Gerenciar Categorias</h2>
                <button id="btn-cancelar-cat" onclick="limparFormularioCategoria()" class="hidden absolute top-6 right-6 text-red-500 text-[10px] font-bold uppercase hover:underline">Cancelar</button>
                <div class="space-y-3">
                    <input type="hidden" id="cat-id">
                    <input type="text" id="cat-nome" placeholder="Nome da Categoria (Ex: Bebidas)" class="w-full p-3 rounded-xl bg-gray-50 border text-sm outline-none focus:border-purple-500">
                    <button onclick="salvarCategoria()" id="btn-salvar-cat" class="w-full bg-purple-600 text-white font-black py-3 rounded-xl shadow-lg shadow-purple-100 active:scale-95 transition-all hover:bg-purple-700">SALVAR CATEGORIA</button>
                </div>
            </section>
            <div id="lista-categorias-admin" class="space-y-3 pb-10"></div>
        </div>

        <div id="view-clientes" class="hidden space-y-4">
            <div class="flex justify-between items-center px-2">
                <h2 class="text-lg font-black text-gray-800 uppercase italic">Base de Clientes</h2>
                <button onclick="carregarClientes()" class="text-xs text-blue-500 font-bold hover:underline"><i class="fas fa-sync-alt"></i> Atualizar</button>
            </div>
            <div id="lista-clientes" class="space-y-3 pb-10"></div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://zpdpscjjxqkbuhesdtyq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3uaoU1fmUEKBrDmbhnk0qw_j3hsPk06';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let produtosCache = []; let configId = null;

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) window.location.href = 'login.html';
            await Promise.all([carregarConfigLoja(), carregarCategorias(), carregarCategoriasAdmin(), carregarProdutos(), carregarClientes()]);
        }

        // --- SISTEMA DE NOTIFICAÇÃO (TOAST) ---
        function mostrarAviso(msg, tipo = 'sucesso') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const cor = tipo === 'erro' ? 'bg-red-500' : 'bg-green-500';
            const icone = tipo === 'erro' ? 'fa-times-circle' : 'fa-check-circle';
            toast.className = `toast ${cor} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 min-w-[250px] z-50`;
            toast.innerHTML = `<i class="fas ${icone}"></i> <span class="text-sm font-bold">${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- SISTEMA DE MODAL (CONFIRMAÇÃO) ---
        function abrirModal(mensagem, funcaoConfirmar) {
            document.getElementById('modal-msg').innerText = mensagem;
            document.getElementById('modal-confirm').classList.remove('hidden');
            const btn = document.getElementById('btn-confirmar-modal');
            // Clona o botão para limpar eventos anteriores
            const novoBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(novoBtn, btn);
            novoBtn.addEventListener('click', async () => {
                novoBtn.innerText = "AGUARDE..."; novoBtn.disabled = true;
                await funcaoConfirmar();
                fecharModal();
                novoBtn.innerText = "SIM, APAGAR"; novoBtn.disabled = false;
            });
        }
        function fecharModal() { document.getElementById('modal-confirm').classList.add('hidden'); }

        // --- LOJA ---
        async function carregarConfigLoja() {
            const { data } = await _supabase.from('store_config').select('*').limit(1);
            if (data && data.length > 0) { configId = data[0].id; actualizarVisualLoja(data[0].is_open); }
        }
        function actualizarVisualLoja(aberta) {
            const b = document.getElementById('status-bolinha'); const t = document.getElementById('status-texto');
            if (aberta) { b.className = "w-3 h-3 rounded-full bg-green-400 shadow-md"; t.innerText = "LOJA ABERTA"; }
            else { b.className = "w-3 h-3 rounded-full bg-red-500 shadow-md"; t.innerText = "FECHADO"; }
        }
        async function alternarLoja() {
            const txt = document.getElementById('status-texto').innerText; const novo = txt === "FECHADO";
            const { error } = await _supabase.from('store_config').update({ is_open: novo }).eq('id', configId);
            if (error) mostrarAviso("Erro ao alterar", "erro"); else { actualizarVisualLoja(novo); mostrarAviso(novo ? "Loja Aberta" : "Loja Fechada"); }
        }

        // --- CATEGORIAS ---
        async function carregarCategoriasAdmin() {
            const { data } = await _supabase.from('categories').select('*').order('name');
            const lista = document.getElementById('lista-categorias-admin'); lista.innerHTML = '';
            data.forEach(c => {
                lista.innerHTML += `<div class="bg-white p-4 rounded-2xl border border-purple-50 flex justify-between items-center shadow-sm">
                    <span class="font-bold text-gray-700">${c.name}</span>
                    <div class="flex gap-2"><button onclick="editarCategoria('${c.id}', '${c.name}')" class="text-blue-500 bg-blue-50 w-8 h-8 rounded-lg"><i class="fas fa-pen text-xs"></i></button>
                    <button onclick="deletarCategoria('${c.id}')" class="text-red-500 bg-red-50 w-8 h-8 rounded-lg"><i class="fas fa-trash text-xs"></i></button></div></div>`;
            });
        }
        async function salvarCategoria() {
            const nome = document.getElementById('cat-nome').value; const id = document.getElementById('cat-id').value;
            if(!nome) return mostrarAviso("Digite um nome", "erro");
            const payload = { name: nome };
            const { error } = id ? await _supabase.from('categories').update(payload).eq('id', id) : await _supabase.from('categories').insert([payload]);
            if (error) mostrarAviso("Erro ao salvar", "erro"); else { mostrarAviso("Categoria Salva!"); limparFormularioCategoria(); carregarCategoriasAdmin(); carregarCategorias(); }
        }
        function editarCategoria(id, nome) { document.getElementById('cat-id').value = id; document.getElementById('cat-nome').value = nome; document.getElementById('btn-salvar-cat').innerText = "ATUALIZAR"; document.getElementById('titulo-cat').innerText = "Editando"; document.getElementById('btn-cancelar-cat').classList.remove('hidden'); }
        function limparFormularioCategoria() { document.getElementById('cat-id').value = ''; document.getElementById('cat-nome').value = ''; document.getElementById('btn-salvar-cat').innerText = "SALVAR CATEGORIA"; document.getElementById('titulo-cat').innerText = "Nova Categoria"; document.getElementById('btn-cancelar-cat').classList.add('hidden'); }
        function deletarCategoria(id) { abrirModal("Se tiver produtos nesta categoria, eles podem sumir.", async () => {
            const { error } = await _supabase.from('categories').delete().eq('id', id);
            if(error) mostrarAviso("Erro ao apagar", "erro"); else { mostrarAviso("Categoria removida"); carregarCategoriasAdmin(); carregarCategorias(); }
        }); }

        // --- PRODUTOS ---
        async function carregarCategorias() { const { data } = await _supabase.from('categories').select('*').order('name'); const s = document.getElementById('prod-categoria'); s.innerHTML = '<option value="">Selecione...</option>'; data.forEach(c => s.innerHTML += `<option value="${c.id}">${c.name}</option>`); }
        async function salvarProduto() {
            const btn = document.getElementById('btn-salvar'); btn.innerText = "GRAVANDO..."; btn.disabled = true;
            try {
                const nome = document.getElementById('prod-nome').value; const cat = document.getElementById('prod-categoria').value; const preco = parseFloat(document.getElementById('prod-preco').value.replace(',', '.'));
                if (!nome || !preco || !cat) throw new Error("Preencha Nome, Preço e Categoria.");
                const file = document.getElementById('prod-foto').files[0]; let imgUrl = null;
                if (file) { const fName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9]/g, '')}`; const { data, error } = await _supabase.storage.from('salgados').upload(fName, file); if (error) throw error; const { data: pub } = _supabase.storage.from('salgados').getPublicUrl(fName); imgUrl = pub.publicUrl; }
                const payload = { name: nome, description: document.getElementById('prod-desc').value, price: preco, sale_price: document.getElementById('prod-preco-promo').value ? parseFloat(document.getElementById('prod-preco-promo').value.replace(',', '.')) : null, on_sale: document.getElementById('prod-em-promo').checked, category_id: cat };
                if (imgUrl) payload.image_url = imgUrl; else if (!document.getElementById('prod-id').value) payload.image_url = 'https://via.placeholder.com/150';
                const id = document.getElementById('prod-id').value; const { error } = id ? await _supabase.from('products').update(payload).eq('id', id) : await _supabase.from('products').insert([payload]);
                if (error) throw error; mostrarAviso("Produto Salvo!"); limparFormulario(); carregarProdutos();
            } catch (e) { mostrarAviso(e.message, "erro"); } finally { btn.innerText = "SALVAR"; btn.disabled = false; }
        }
        async function carregarProdutos() {
            const { data } = await _supabase.from('products').select('*, categories(name)').order('created_at', { ascending: false }); produtosCache = data; const l = document.getElementById('lista-produtos'); l.innerHTML = '';
            data.forEach(p => { l.innerHTML += `<div class="bg-white p-3 rounded-2xl border border-gray-100 flex items-center gap-3"><img src="${p.image_url}" class="w-12 h-12 rounded-lg object-cover bg-gray-50"><div class="flex-grow min-w-0"><p class="font-bold text-gray-800 text-sm truncate">${p.name}</p><p class="text-orange-600 font-bold text-xs">R$ ${p.on_sale ? p.sale_price : p.price}</p></div><div class="flex gap-1"><button onclick="editar('${p.id}')" class="bg-blue-50 text-blue-500 w-8 h-8 rounded-lg"><i class="fas fa-pen text-xs"></i></button><button onclick="deletar('${p.id}')" class="bg-red-50 text-red-500 w-8 h-8 rounded-lg"><i class="fas fa-trash text-xs"></i></button></div></div>`; });
        }
        function editar(id) { const p = produtosCache.find(x => x.id === id); if(!p) return; document.getElementById('prod-id').value = p.id; document.getElementById('prod-nome').value = p.name; document.getElementById('prod-desc').value = p.description||''; document.getElementById('prod-categoria').value = p.category_id; document.getElementById('prod-preco').value = p.price; document.getElementById('prod-preco-promo').value = p.sale_price||''; document.getElementById('prod-em-promo').checked = p.on_sale; document.getElementById('btn-salvar').innerText = "ATUALIZAR"; document.getElementById('titulo-form').innerText = "Editando"; document.getElementById('btn-cancelar').classList.remove('hidden'); }
        function limparFormulario() { document.getElementById('prod-id').value = ''; document.getElementById('prod-nome').value = ''; document.getElementById('prod-desc').value = ''; document.getElementById('prod-preco').value = ''; document.getElementById('prod-preco-promo').value = ''; document.getElementById('prod-em-promo').checked = false; document.getElementById('btn-salvar').innerText = "SALVAR"; document.getElementById('titulo-form').innerText = "Novo Item"; document.getElementById('btn-cancelar').classList.add('hidden'); }
        function deletar(id) { abrirModal("Deseja apagar este produto?", async () => { const { error } = await _supabase.from('products').delete().eq('id', id); if(error) mostrarAviso("Erro", "erro"); else { mostrarAviso("Apagado!"); carregarProdutos(); } }); }

        // --- CLIENTES ---
        async function carregarClientes() {
            const l = document.getElementById('lista-clientes'); l.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-gray-400"></i></div>';
            const { data, error } = await _supabase.from('clients').select('*').order('created_at', { ascending: false });
            if (error || !data) { l.innerHTML = '<p class="text-center text-gray-400 text-xs">Vazio.</p>'; return; } l.innerHTML = '';
            data.forEach(c => { const w = c.phone ? `https://wa.me/55${c.phone.replace(/\D/g, '')}` : '#'; l.innerHTML += `<div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm"><div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-gray-800 text-sm">${c.name}</h3><p class="text-xs text-gray-400">${c.email||''}</p></div><div class="flex gap-2"><a href="${w}" target="_blank" class="text-green-600 bg-green-50 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fab fa-whatsapp"></i></a><button onclick="removerCliente('${c.id}', '${c.name}')" class="text-red-500 bg-red-50 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-trash-alt text-xs"></i></button></div></div><div class="bg-gray-50 p-2 rounded-xl text-xs text-gray-600"><i class="fas fa-map-marker-alt text-orange-400"></i> ${c.address||'-'}</div></div>`; });
        }
        function removerCliente(id, nome) { abrirModal(`Remover ${nome}? O login dele pode continuar ativo até limpeza.`, async () => { const { error } = await _supabase.from('clients').delete().eq('id', id); if(error) mostrarAviso("Erro", "erro"); else { mostrarAviso("Removido!"); carregarClientes(); } }); }

        function mudarAba(aba) { ['produtos', 'categorias', 'clientes'].forEach(x => { document.getElementById('view-'+x).classList.add('hidden'); document.getElementById('tab-'+x).className = "flex-1 py-2 text-[10px] font-bold uppercase rounded-xl text-gray-400"; }); document.getElementById('view-'+aba).classList.remove('hidden'); document.getElementById('tab-'+aba).className = "flex-1 py-2 text-[10px] font-bold uppercase rounded-xl bg-orange-100 text-orange-700 shadow-sm"; if(aba==='categorias') carregarCategoriasAdmin(); if(aba==='clientes') carregarClientes(); }
        async function sair() { await _supabase.auth.signOut(); window.location.href = 'login.html'; }
        init();
    </script>
</body>
</html>